<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merakelysi - Mi Universo Literario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- General & Base Styles --- */
        :root {
            --pink: #f472b6;
            --purple: #a855f7;
            --blue: #60a5fa;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --bg-light: rgba(255, 255, 255, 0.85);
            --border-light: rgba(229, 231, 235, 0.7);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #fdf2f8, #f5f3ff, #ecfdf5);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><text y='20' font-size='20'>ü¶Ñ</text></svg>"), auto;
        }

        body.modal-open {
            overflow: hidden;
        }
        
        /* --- A11Y & UX Improvements --- */
        input, button, textarea, select {
            font-family: inherit;
            cursor: pointer;
        }
        
        *:focus-visible {
            outline: 3px solid var(--blue);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* --- Decorative Background Elements --- */
        .bg-decoration {
            position: fixed;
            opacity: 0.07;
            pointer-events: none;
            z-index: -1; /* Behind everything */
            animation: float 6s ease-in-out infinite;
        }
        .bg-book-1 { top: 10%; left: 5%; font-size: 5rem; animation-duration: 8s; }
        .bg-book-2 { top: 70%; left: 8%; font-size: 3rem; animation-duration: 10s; }
        .bg-butterfly { bottom: 20%; right: 10%; font-size: 6rem; animation: float-butterfly 12s ease-in-out infinite; }
        .bg-star { top: 25%; right: 15%; font-size: 3rem; animation-duration: 12s; }
        .bg-flower { top: 60%; right: 5%; font-size: 4rem; animation-duration: 9s; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* --- Header Styles --- */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2.5rem 2rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 10vw, 5rem);
            font-weight: 700;
            background: linear-gradient(to right, var(--pink), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 15px rgba(168, 85, 247, 0.1);
        }

        .author-attribution { font-size: 1rem; color: var(--purple); font-weight: 600; margin-bottom: 1.5rem; }

        .user-name-input { margin-bottom: 1rem; }
        .user-name-input label { font-size: 1.2rem; color: var(--text-secondary); font-weight: 600; }
        .user-name-input input {
            border: none;
            border-bottom: 2px dashed var(--pink);
            background: none;
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
            width: 220px;
            padding: 0.2rem 0.5rem;
            transition: border-color 0.3s ease;
        }
        .user-name-input input:focus { outline: none; border-bottom-color: var(--purple); }
        
        .status { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .status-dot { width: 8px; height: 8px; background-color: var(--green); border-radius: 50%; animation: pulse-status 2s infinite; }
        .status-text { font-size: 0.8rem; color: #9ca3af; font-weight: 500; }
        
        /* --- General UI Components (Buttons, Cards) --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .card {
            background: var(--bg-light);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-lg); }
        .card-icon { font-size: 2.5rem; margin-bottom: 1rem; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }

        .btn {
            background: linear-gradient(135deg, var(--pink), #e879f9);
            color: white; border: none; padding: 0.8rem 1.6rem; border-radius: 12px;
            font-weight: 600; font-size: 1rem; transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(244, 114, 182, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(244, 114, 182, 0.3); }
        .btn:active { transform: translateY(0); }
        .btn.back-btn { background: linear-gradient(135deg, #cbd5e1, #94a3b8); }
        .btn.back-btn:hover { box-shadow: 0 8px 16px rgba(148, 163, 184, 0.3); }

        /* --- Section Styles --- */
        .nav-section { display: none; }
        .nav-section.active { display: block; animation: fadeIn 0.5s ease; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        
        .items-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }

        .item-card {
            background: var(--bg-light); border-radius: 16px; padding: 1.5rem;
            box-shadow: var(--shadow-md); border: 1px solid var(--border-light);
            position: relative; transition: all 0.3s ease; backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .item-content { flex-grow: 1; word-wrap: break-word; }
        .item-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
        .item-subtitle { color: var(--text-secondary); font-weight: 500; margin-bottom: 0.75rem; }
        .item-meta { color: var(--purple); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .item-notes { font-size: 0.9rem; color: var(--text-secondary); white-space: pre-wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-light); }
        
        .item-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
        .action-btn {
            background: #a78bfa; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px;
            font-size: 0.8rem; font-weight: 600; transition: all 0.2s ease;
        }
        .action-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .action-btn.action-edit { background-color: var(--blue); }
        .action-btn.action-finish { background-color: var(--green); }
        .action-btn.action-review { background-color: var(--yellow); }
        .action-btn.action-add { background-color: var(--pink); }
        
        .delete-btn {
            position: absolute; top: 0.75rem; right: 0.75rem; background: #fca5a5; color: white; border: none;
            width: 28px; height: 28px; border-radius: 50%; font-size: 1.2rem; font-weight: bold;
            display: flex; justify-content: center; align-items: center; line-height: 1; transition: all 0.2s ease;
            opacity: 0.5;
        }
        .item-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: var(--red); transform: scale(1.1) rotate(90deg); }

        /* --- Empty State --- */
        .empty-state {
            text-align: center; padding: 4rem 2rem; color: var(--text-secondary); background: var(--bg-light);
            border-radius: 24px; border: 2px dashed var(--border-light); backdrop-filter: blur(10px);
            grid-column: 1 / -1; /* Ocupa todo el ancho del grid */
        }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        
        /* --- Modal Styles --- */
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(245, 243, 255, 0.5);
            backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }

        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f5f3ff); padding: 2.5rem; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; max-width: 550px;
            width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid white;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .modal-content h3 { font-size: 1.75rem; font-family: 'Playfair Display', serif; color: var(--text-primary); margin-bottom: 2rem; text-align: center; }

        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.75rem;
            cursor: pointer; color: #9ca3af; transition: color 0.2s ease, transform 0.2s ease; line-height: 1;
        }
        .modal-close-btn:hover { color: var(--red); transform: rotate(90deg); }

        .form-group { margin-bottom: 1rem; }
        .modal-form label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary); }
        .modal-form input, .modal-form textarea, .modal-form select {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 1rem; color: var(--text-primary); background-color: #f9fafb;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-form input:focus, .modal-form textarea:focus, .modal-form select:focus {
            outline: none; border-color: var(--pink); box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2);
        }
        .modal-form textarea { min-height: 100px; resize: vertical; }
        .modal-form button[type="submit"] { width: 100%; margin-top: 1.5rem; background: linear-gradient(135deg, var(--purple), var(--pink)); }
        
        /* --- Notification & Celebration System --- */
        #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .notification {
            padding: 1rem 1.5rem; border-radius: 12px; color: white;
            box-shadow: var(--shadow-lg); font-weight: 600;
            transform: translateX(calc(100% + 20px));
            animation: slide-in 0.5s forwards, slide-out 0.5s 3s forwards;
        }
        .notification.success { background: linear-gradient(135deg, var(--green), #34d399); }
        .notification.error { background: linear-gradient(135deg, var(--red), #f87171); }
        @keyframes slide-in { to { transform: translateX(0); } }
        @keyframes slide-out { to { transform: translateX(calc(100% + 20px)); } }
        
        #celebration-container { position: fixed; inset: 0; z-index: 3000; pointer-events: none; overflow: hidden; }
        .celebration-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 2rem 3rem; background: var(--bg-light); border-radius: 24px; box-shadow: var(--shadow-lg);
            text-align: center; animation: celebrate-fade 4s ease-out; backdrop-filter: blur(10px);
        }
        .celebration-message span { font-size: 4rem; display: block; }
        .celebration-message p { font-size: 1.5rem; font-weight: 600; color: var(--purple); margin-top: 1rem; }
        .confetti {
            position: absolute; width: 10px; height: 10px; background-color: var(--pink);
            top: -20px; animation: fall 3s linear infinite;
        }
        @keyframes celebrate-fade { 0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } 20%, 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        
        /* --- Animations --- */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        @keyframes float-butterfly { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }
        @keyframes pulse-status { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .section-header { flex-direction: column; align-items: stretch; text-align: center; }
            .items-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Elementos Decorativos -->
    <div class="bg-decoration bg-book-1">üìö</div>
    <div class="bg-decoration bg-book-2">üìñ</div>
    <div class="bg-decoration bg-butterfly">ü¶ã</div>
    <div class="bg-decoration bg-star">‚ú®</div>
    <div class="bg-decoration bg-flower">üå∏</div>

    <!-- Contenedor Principal de la App -->
    <div class="container">
        <!-- Cada secci√≥n se renderizar√° aqu√≠ din√°micamente -->
        <section id="home" class="nav-section"></section>
        <section id="books" class="nav-section"></section>
        <section id="clubs" class="nav-section"></section>
        <section id="calendar" class="nav-section"></section>
        <section id="quotes" class="nav-section"></section>
        <section id="wishlist" class="nav-section"></section>
        <section id="bookReviews" class="nav-section"></section>
        <section id="generalReviews" class="nav-section"></section>
        <section id="playlists" class="nav-section"></section>
        <section id="diary" class="nav-section"></section>
        <section id="progress" class="nav-section"></section>
        <section id="challenges" class="nav-section"></section>
        <section id="tributes" class="nav-section"></section>
        <section id="stats" class="nav-section"></section>
        <section id="monthly" class="nav-section"></section>
        <section id="finished" class="nav-section"></section>
        <section id="favorites" class="nav-section"></section>
        <section id="suggestions" class="nav-section"></section>
    </div>

    <!-- Contenedores para elementos din√°micos -->
    <div id="modal-container"></div>
    <div id="notification-container"></div>
    <div id="celebration-container"></div>
    
    <!-- Plantillas HTML para Modales -->
    <template id="modal-template-book">
        <div class="modal-backdrop" id="bookModal">
            <div class="modal-content" role="dialog" aria-modal="true">
                <button class="modal-close-btn" aria-label="Cerrar modal">√ó</button>
                <h3>Agregar Nuevo Libro</h3>
                <form class="modal-form" data-section="books">
                    <input type="hidden" name="id" value="">
                    <div class="form-group">
                        <label for="bookTitle">T√≠tulo del Libro</label>
                        <input type="text" id="bookTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Autor(a)</label>
                        <input type="text" id="bookAuthor" name="author" required>
                    </div>
                    <div class="form-group">
                        <label for="bookNotes">Notas Iniciales</label>
                        <textarea id="bookNotes" name="notes" placeholder="¬øPor qu√© quieres leerlo? ¬øAlguna expectativa?"></textarea>
                    </div>
                    <button type="submit" class="btn">Guardar Libro</button>
                </form>
            </div>
        </div>
    </template>

    <template id="modal-template-wish">
        <div class="modal-backdrop" id="wishModal">
            <div class="modal-content" role="dialog" aria-modal="true">
                <button class="modal-close-btn" aria-label="Cerrar modal">√ó</button>
                <h3>Agregar a Wishlist</h3>
                <form class="modal-form" data-section="wishlist">
                    <input type="hidden" name="id" value="">
                    <div class="form-group">
                        <label for="wishTitle">T√≠tulo del Libro</label>
                        <input type="text" id="wishTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="wishAuthor">Autor(a)</label>
                        <input type="text" id="wishAuthor" name="author" required>
                    </div>
                    <div class="form-group">
                        <label for="wishReason">Raz√≥n (¬øPor qu√© lo quieres?)</label>
                        <textarea id="wishReason" name="reason"></textarea>
                    </div>
                    <button type="submit" class="btn">Guardar Deseo</button>
                </form>
            </div>
        </div>
    </template>
    
    <!-- Agrega m√°s plantillas para otros modales aqu√≠ si es necesario -->

<script>
// ===================================================================================
// MERAKELYSI APP 3.0 - ARQUITECTURA ROBUSTA Y FUNCIONAL
// Arquitecto de C√≥digo: Tu Asistente IA de Confianza
// Fecha: Actual
// ===================================================================================

/**
 * @file app.js
 * @description L√≥gica principal de la aplicaci√≥n Merakelysi.
 * @summary Este script ha sido completamente reestructurado para ser funcional,
 * seguro, mantenible y ofrecer una experiencia de usuario excepcional.
 * Se utiliza un patr√≥n modular, delegaci√≥n de eventos y plantillas HTML.
 */
document.addEventListener('DOMContentLoaded', () => {

    // -----------------------------------------------------------------------------------
    // 1. CONFIGURACI√ìN Y ESTADO GLOBAL
    // -----------------------------------------------------------------------------------
    const config = {
        storageKey: 'merakelysi_data_v3',
        userNameKey: 'merakelysi_userName_v3',
        pastelColors: ['#f472b6', '#a855f7', '#60a5fa', '#10b981', '#f59e0b', '#ef4444', '#fde68a'],
        sections: [
            { id: 'books', title: 'Mis Libros por Leer', icon: 'üìö', modal: 'bookModal', formTemplate: 'modal-template-book' },
            { id: 'finished', title: 'Lecturas Terminadas', icon: '‚úÖ' },
            { id: 'wishlist', title: 'Wishlist de Libros', icon: 'üíñ', modal: 'wishModal', formTemplate: 'modal-template-wish' },
            { id: 'stats', title: 'Estad√≠sticas', icon: 'üìä' },
            { id: 'suggestions', title: 'Sugerencias', icon: 'ü§ñ' },
            // ... (A√±ade el resto de secciones aqu√≠ a medida que las implementes)
            { id: 'quotes', title: 'Frases de Lecturas', icon: 'üìù', dev: true },
            { id: 'clubs', title: 'Clubes de Lectura', icon: 'üë•', dev: true },
        ]
    };

    const state = {
        currentSection: 'home',
        userName: '',
        db: {}
    };

    // -----------------------------------------------------------------------------------
    // 2. M√ìDULO DE UTILIDADES (SEGURIDAD Y AYUDANTES)
    // -----------------------------------------------------------------------------------
    const utils = {
        generateId: () => Date.now() + Math.random().toString(36).substr(2, 9),
        sanitizeHTML: (str) => {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
    };
    
    // -----------------------------------------------------------------------------------
    // 3. M√ìDULO DE ALMACENAMIENTO (STORAGE)
    // -----------------------------------------------------------------------------------
    const storage = {
        save() {
            try {
                localStorage.setItem(config.storageKey, JSON.stringify(state.db));
            } catch (error) {
                console.error('‚ùå Error al guardar datos:', error);
                ui.showNotification('Error al guardar los datos.', 'error');
            }
        },
        load() {
            const emptyDB = {
                books: [], wishlist: [], quotes: [], clubs: [], suggestions: [] // Inicializa todas las colecciones
            };
            try {
                const savedData = localStorage.getItem(config.storageKey);
                const parsedData = savedData ? JSON.parse(savedData) : emptyDB;
                // Migraci√≥n inteligente: Asegura que todas las claves del DB existan
                state.db = { ...emptyDB, ...parsedData };
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                state.db = emptyDB;
                alert('Hubo un error al cargar tus datos. Se ha iniciado una sesi√≥n nueva.');
            }
        },
        loadUserName() {
            state.userName = localStorage.getItem(config.userNameKey) || '';
            document.getElementById('userName').value = state.userName;
        },
        saveUserName(name) {
            state.userName = name;
            localStorage.setItem(config.userNameKey, state.userName);
        }
    };

    // -----------------------------------------------------------------------------------
    // 4. M√ìDULO DE INTERFAZ DE USUARIO (UI) - El "View"
    // -----------------------------------------------------------------------------------
    const ui = {
        elements: {
            container: document.querySelector('.container'),
            modalContainer: document.getElementById('modal-container'),
            notificationContainer: document.getElementById('notification-container'),
            celebrationContainer: document.getElementById('celebration-container'),
        },

        renderSection(sectionId) {
            document.querySelectorAll('.nav-section').forEach(s => s.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                state.currentSection = sectionId;
                this.renderContentForCurrentSection();
                window.scrollTo(0, 0);
            }
        },

        renderContentForCurrentSection() {
            const sectionId = state.currentSection;
            const sectionEl = document.getElementById(sectionId);
            if (!sectionEl) return;

            if (sectionId === 'home') {
                this._renderHomePage();
                return;
            }

            const sectionConfig = config.sections.find(s => s.id === sectionId);
            if (!sectionConfig) return;

            sectionEl.innerHTML = this._createSectionHeader(sectionConfig);
            const contentContainer = document.createElement('div');
            contentContainer.id = `${sectionId}Container`;
            contentContainer.className = 'items-grid';
            sectionEl.appendChild(contentContainer);
            
            // Llama a la funci√≥n de renderizado espec√≠fica
            const renderFn = rendering[sectionId] || rendering.default;
            renderFn(contentContainer, sectionConfig);
        },

        _renderHomePage() {
            const homeSection = document.getElementById('home');
            homeSection.innerHTML = `
                <header class="header">
                    <h1 class="title">Merakelysi</h1>
                    <p class="author-attribution">By Maribel Alba</p>
                    <div class="user-name-input">
                        <label for="userName">Hola, </label>
                        <input type="text" id="userName" placeholder="tu nombre aqu√≠" value="${utils.sanitizeHTML(state.userName)}">
                    </div>
                    <div class="status">
                        <div class="status-dot"></div>
                        <span class="status-text">Datos guardados en tu navegador</span>
                    </div>
                </header>
                <main id="homeGrid" class="grid">
                    ${config.sections.map(s => `
                        <div class="card" data-action="navigate" data-section-id="${s.id}">
                            <div class="card-icon">${s.icon}</div>
                            <h3 class="card-title">${s.title}${s.dev ? ' (en desarrollo)' : ''}</h3>
                        </div>
                    `).join('')}
                </main>`;
        },

        _createSectionHeader(sectionConfig) {
            let buttonHtml = '';
            if(sectionConfig.modal){
                 buttonHtml = `<button class="btn" data-action="open-modal" data-modal-id="${sectionConfig.modal}">+ Agregar</button>`;
            } else if (sectionConfig.id === 'suggestions') {
                 buttonHtml = `<button class="btn" data-action="generate-suggestions">üîÑ Generar Sugerencias</button>`;
            }

            return `
                <div class="section-header">
                    <button class="btn back-btn" data-action="navigate" data-section-id="home">‚Üê Inicio</button>
                    <h2 class="section-title">${sectionConfig.title}</h2>
                    ${buttonHtml}
                </div>`;
        },

        showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            this.elements.notificationContainer.appendChild(notif);
            setTimeout(() => notif.remove(), 3500);
        },
        
        showCelebration(message) {
            const celebration = document.createElement('div');
            celebration.className = 'celebration-message';
            celebration.innerHTML = `<span>üéâ</span><p>${utils.sanitizeHTML(message)}</p>`;
            this.elements.celebrationContainer.appendChild(celebration);
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = config.pastelColors[Math.floor(Math.random() * config.pastelColors.length)];
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                this.elements.celebrationContainer.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
            setTimeout(() => celebration.remove(), 4000);
        }
    };

    // -----------------------------------------------------------------------------------
    // 5. M√ìDULO DE MODALES (MODALS)
    // -----------------------------------------------------------------------------------
    const modals = {
        open(modalId, itemId = null) {
            const sectionConfig = config.sections.find(s => s.modal === modalId);
            if (!sectionConfig || !document.getElementById(sectionConfig.formTemplate)) {
                console.error(`Modal o plantilla para ${modalId} no encontrado.`);
                return;
            }

            const template = document.getElementById(sectionConfig.formTemplate);
            const clone = template.content.cloneNode(true);
            const modalEl = clone.querySelector('.modal-backdrop');
            
            const form = modalEl.querySelector('form');
            const titleEl = modalEl.querySelector('h3');
            const submitBtn = modalEl.querySelector('button[type="submit"]');

            if (itemId) { // Modo Edici√≥n
                const itemData = state.db[form.dataset.section].find(item => item.id == itemId);
                if (itemData) {
                    titleEl.textContent = titleEl.textContent.replace('Agregar', 'Editar');
                    submitBtn.textContent = 'Guardar Cambios';
                    for (const key in itemData) {
                        if (form.elements[key]) {
                            form.elements[key].value = itemData[key];
                        }
                    }
                }
            }
            
            ui.elements.modalContainer.innerHTML = '';
            ui.elements.modalContainer.appendChild(clone);
            
            // Forzar reflow para la animaci√≥n
            requestAnimationFrame(() => {
                modalEl.classList.add('active');
                modalEl.querySelector('input, textarea, select, button').focus();
            });
            document.body.classList.add('modal-open');
        },
        close() {
            const modalEl = ui.elements.modalContainer.querySelector('.modal-backdrop');
            if(modalEl) {
                modalEl.classList.remove('active');
                modalEl.addEventListener('transitionend', () => {
                    ui.elements.modalContainer.innerHTML = '';
                    document.body.classList.remove('modal-open');
                }, { once: true });
            }
        }
    };

    // -----------------------------------------------------------------------------------
    // 6. M√ìDULO DE RENDERIZADO DE CONTENIDO
    // -----------------------------------------------------------------------------------
    const rendering = {
        _createItemCard({ id, section, title, subtitle, meta, notes, buttons = [] }) {
            const sanitizedTitle = utils.sanitizeHTML(title);
            const sanitizedSubtitle = subtitle ? utils.sanitizeHTML(subtitle) : '';
            const sanitizedMeta = meta ? utils.sanitizeHTML(meta) : '';
            const sanitizedNotes = notes ? utils.sanitizeHTML(notes) : '';
            
            const buttonsHtml = buttons.map(btn => 
                `<button class="action-btn ${btn.class}" data-action="${btn.action}" data-id="${id}">${btn.label}</button>`
            ).join('');

            return `
                <div class="item-card" data-id="${id}">
                    <button class="delete-btn" data-action="delete-item" data-section="${section}" data-id="${id}" aria-label="Eliminar ${sanitizedTitle}">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${sanitizedTitle}</h3>
                        ${subtitle ? `<p class="item-subtitle">${sanitizedSubtitle}</p>` : ''}
                        ${meta ? `<p class="item-meta">${sanitizedMeta}</p>` : ''}
                        ${notes ? `<p class="item-notes">${sanitizedNotes}</p>` : ''}
                    </div>
                    <div class="item-actions">${buttonsHtml}</div>
                </div>`;
        },

        _renderEmptyState(container, icon, message, submessage) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">${icon}</div>
                    <h3>${message}</h3>
                    <p>${submessage}</p>
                </div>`;
        },

        default(container, sectionConfig) {
            this._renderEmptyState(container, 'üöß', `Secci√≥n "${sectionConfig.title}" en Construcci√≥n`, 'Vuelve pronto para ver las novedades.');
        },

        books(container) {
            const items = state.db.books.filter(b => !b.isFinished);
            if (items.length === 0) {
                this._renderEmptyState(container, 'üìö', 'No hay libros por leer', '¬°Agrega un nuevo libro para empezar!');
                return;
            }
            container.innerHTML = items.map(book => this._createItemCard({
                id: book.id,
                section: 'books',
                title: book.title,
                subtitle: `por ${book.author}`,
                notes: book.notes,
                buttons: [
                    { class: 'action-edit', label: 'Editar', action: 'edit-item' },
                    { class: 'action-finish', label: '‚úÖ Terminado', action: 'finish-book' }
                ]
            })).join('');
        },
        
        finished(container) {
            const items = state.db.books.filter(b => b.isFinished);
            if (items.length === 0) {
                this._renderEmptyState(container, '‚úÖ', 'A√∫n no has terminado ning√∫n libro', '¬°Sigue leyendo! Los libros que termines aparecer√°n aqu√≠.');
                return;
            }
            container.innerHTML = items.map(book => this._createItemCard({
                id: book.id,
                section: 'books',
                title: book.title,
                subtitle: `por ${book.author}`,
                meta: '¬°Lectura completada!',
                buttons: [ /* Podr√≠as a√±adir un bot√≥n para ver/editar rese√±a */ ]
            })).join('');
        },

        wishlist(container) {
            const items = state.db.wishlist;
             if (items.length === 0) {
                this._renderEmptyState(container, 'üíñ', 'Tu wishlist est√° vac√≠a', 'Agrega los libros que te mueres por leer.');
                return;
            }
            container.innerHTML = items.map(item => this._createItemCard({
                id: item.id,
                section: 'wishlist',
                title: item.title,
                subtitle: `por ${item.author}`,
                notes: item.reason,
                buttons: [
                    { class: 'action-edit', label: 'Editar', action: 'edit-item' },
                    { class: 'action-add', label: 'üìö Mover a "Por Leer"', action: 'move-wish-to-books' }
                ]
            })).join('');
        },

        suggestions(container) {
            const items = state.db.suggestions;
            if (items.length === 0) {
                this._renderEmptyState(container, 'ü§ñ', 'No hay sugerencias', '¬°Haz clic en "Generar Sugerencias" para descubrir tu pr√≥xima lectura!');
                return;
            }
            container.innerHTML = items.map(item => this._createItemCard({
                id: item.id,
                section: 'suggestions',
                title: item.title,
                subtitle: `de ${item.author}`,
                buttons: [
                    { class: 'action-add', label: 'üíñ A√±adir a Wishlist', action: 'add-suggestion-to-wishlist' }
                ]
            })).join('');
        },

        stats(container) {
            const booksRead = state.db.books.filter(b => b.isFinished).length;
            const booksToRead = state.db.books.filter(b => !b.isFinished).length;
            const booksInWishlist = state.db.wishlist.length;
            
            container.className = 'grid'; // Usamos el grid de la home
            container.innerHTML = `
                <div class="card"><div class="card-icon">‚úÖ</div><h3 class="card-title">Has le√≠do<br><span style="font-size: 2rem; color: var(--green);">${booksRead}</span><br>libros</h3></div>
                <div class="card"><div class="card-icon">üìö</div><h3 class="card-title">Tienes<br><span style="font-size: 2rem; color: var(--blue);">${booksToRead}</span><br>por leer</h3></div>
                <div class="card"><div class="card-icon">üíñ</div><h3 class="card-title">Deseas<br><span style="font-size: 2rem; color: var(--pink);">${booksInWishlist}</span><br>libros</h3></div>
            `;
        }
    };

    // -----------------------------------------------------------------------------------
    // 7. M√ìDULO DE L√ìGICA DE LA APLICACI√ìN (APP) - El "Controller"
    // -----------------------------------------------------------------------------------
    const app = {
        init() {
            storage.load();
            ui.renderSection('home');
            this.addEventListeners();
            console.log("ü¶Ñ Merakelysi App 3.0 inicializada.");
        },

        addEventListeners() {
            // Delegaci√≥n de eventos en el body para todas las acciones
            document.body.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (!action) return;

                const id = e.target.dataset.id;
                
                switch(action) {
                    case 'navigate':
                        ui.renderSection(e.target.dataset.sectionId);
                        break;
                    case 'open-modal':
                        modals.open(e.target.dataset.modalId);
                        break;
                    case 'edit-item':
                        const section = state.currentSection;
                        const modalId = config.sections.find(s => s.id === section)?.modal;
                        if(modalId) modals.open(modalId, id);
                        break;
                    case 'delete-item':
                        this.deleteItem(e.target.dataset.section, id);
                        break;
                    case 'finish-book':
                        this.markBookAsFinished(id);
                        break;
                    case 'generate-suggestions':
                        this.generateSuggestions();
                        break;
                    case 'add-suggestion-to-wishlist':
                        this.addSuggestionToWishlist(id);
                        break;
                    case 'move-wish-to-books':
                        this.moveWishToBooks(id);
                        break;
                }
            });

            // Cierre de modales
            ui.elements.modalContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-backdrop') || e.target.classList.contains('modal-close-btn')) {
                    modals.close();
                }
            });

            // Guardado de formularios de modales
            ui.elements.modalContainer.addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.tagName === 'FORM') {
                    this.handleFormSubmit(e.target);
                }
            });
            
            // Guardar nombre de usuario
            document.body.addEventListener('change', (e) => {
                if(e.target.id === 'userName') {
                    storage.saveUserName(e.target.value);
                }
            });

            // Guardar todo al salir
            window.addEventListener('beforeunload', storage.save);
        },
        
        handleFormSubmit(form) {
            const sectionKey = form.dataset.section;
            if (!state.db[sectionKey]) {
                console.error(`Secci√≥n de DB "${sectionKey}" no existe.`);
                return;
            }
            
            const formData = new FormData(form);
            const itemData = Object.fromEntries(formData.entries());
            const itemId = itemData.id;
            
            delete itemData.id;

            if (itemId) { // Editar
                const index = state.db[sectionKey].findIndex(item => item.id == itemId);
                if (index > -1) {
                    state.db[sectionKey][index] = { ...state.db[sectionKey][index], ...itemData };
                    ui.showNotification('¬°Elemento actualizado!', 'success');
                }
            } else { // Agregar
                itemData.id = utils.generateId();
                if(sectionKey === 'books') { // A√±adir campos por defecto
                    itemData.isFinished = false;
                }
                state.db[sectionKey].push(itemData);
                ui.showNotification('¬°Elemento agregado!', 'success');
            }
            
            storage.save();
            ui.renderContentForCurrentSection();
            modals.close();
        },

        deleteItem(sectionKey, itemId) {
            if (confirm('¬øEst√°s segura de que quieres eliminar este elemento?')) {
                state.db[sectionKey] = state.db[sectionKey].filter(item => item.id != itemId);
                ui.renderContentForCurrentSection();
                ui.showNotification('Elemento eliminado.', 'success');
            }
        },

        markBookAsFinished(bookId) {
            const book = state.db.books.find(b => b.id == bookId);
            if (book && confirm(`¬øMarcar "${book.title}" como terminado?`)) {
                book.isFinished = true;
                ui.renderContentForCurrentSection();
                ui.showCelebration(`¬°Felicidades por terminar "${book.title}"!`);
            }
        },

        addSuggestionToWishlist(suggestionId) {
            const suggestion = state.db.suggestions.find(s => s.id == suggestionId);
            if(suggestion) {
                state.db.wishlist.push({
                    id: utils.generateId(),
                    title: suggestion.title,
                    author: suggestion.author,
                    reason: 'Sugerencia autom√°tica de Merakelysi.'
                });
                // Opcional: eliminar sugerencia para no repetirla
                state.db.suggestions = state.db.suggestions.filter(s => s.id != suggestionId);
                ui.renderContentForCurrentSection();
                ui.showNotification(`"${suggestion.title}" a√±adido a tu wishlist!`, 'success');
            }
        },

        moveWishToBooks(wishId) {
            const wishItem = state.db.wishlist.find(w => w.id == wishId);
            if(wishItem) {
                state.db.books.push({
                    id: utils.generateId(),
                    title: wishItem.title,
                    author: wishItem.author,
                    notes: `Movido desde la wishlist. Raz√≥n original: ${wishItem.reason || 'Ninguna.'}`,
                    isFinished: false,
                });
                state.db.wishlist = state.db.wishlist.filter(w => w.id != wishId);
                ui.renderContentForCurrentSection();
                ui.showNotification(`"${wishItem.title}" movido a "Mis Libros por Leer".`, 'success');
            }
        },
        
        generateSuggestions() {
            ui.showNotification('Buscando joyas literarias para ti...');
            const allBooks = [
                { title: "El nombre del viento", author: "Patrick Rothfuss" },
                { title: "Cien a√±os de soledad", author: "Gabriel Garc√≠a M√°rquez" },
                { title: "1984", author: "George Orwell" },
                { title: "Orgullo y prejuicio", author: "Jane Austen" },
                { title: "La sombra del viento", author: "Carlos Ruiz Zaf√≥n" },
                { title: "Dune", author: "Frank Herbert" },
                { title: "El priorato del naranjo", author: "Samantha Shannon" },
                { title: "Circe", author: "Madeline Miller" },
            ];
            // Filtra libros que ya est√°n en la lista de "por leer" o "wishlist"
            const userBooks = [...state.db.books.map(b => b.title), ...state.db.wishlist.map(w => w.title)];
            const availableSuggestions = allBooks.filter(b => !userBooks.includes(b.title));

            state.db.suggestions = availableSuggestions.sort(() => 0.5 - Math.random()).slice(0, 3)
                .map(b => ({ ...b, id: utils.generateId() }));
            
            ui.renderContentForCurrentSection();
            ui.showNotification('¬°Nuevas sugerencias listas!', 'success');
        }
    };

    // -----------------------------------------------------------------------------------
    // 8. INICIALIZACI√ìN DE LA APP
    // -----------------------------------------------------------------------------------
    app.init();
});
</script>
</body>
</html>
