<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merakelysi - Mi Universo Literario</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink: #f472b6; --purple: #a855f7; --blue: #60a5fa; --green: #34d399; --yellow: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background: linear-gradient(135deg, #fef7f0, #faf2f2, #f0f4f8, #f8f0f5, #f5f3ff); min-height: 100vh; cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><text y='20' font-size='20'>ü¶Ñ</text></svg>"), auto; overflow-y: auto; }
        body.modal-open { overflow: hidden; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .bg-decoration { position: fixed; opacity: 0.08; pointer-events: none; z-index: -1; animation: float 6s ease-in-out infinite; }
        .bg-book-1 { top: 10%; left: 5%; font-size: 4rem; }
        .bg-butterfly { bottom: 20%; left: 10%; font-size: 7rem; animation-name: pulse; }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.08; } 50% { transform: scale(1.1); opacity: 0.15; } }

        .header { text-align: center; margin-bottom: 3rem; padding: 2rem 0; background: linear-gradient(135deg, rgba(255,255,255,0.7), rgba(248,250,252,0.5)); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(5px); }
        .title { font-family: 'Playfair Display', serif; font-size: 4rem; font-weight: bold; background: linear-gradient(to right, var(--pink), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .subtitle { font-size: 1.2rem; color: #6b7280; margin-top: 0.5rem; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .card { background: rgba(255,255,255,0.8); border-radius: 24px; padding: 2rem 1.5rem; box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6); cursor: pointer; transition: all 0.3s ease; text-align: center; backdrop-filter: blur(10px); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 25px 40px -12px rgba(0,0,0,0.15); }
        .card-icon { font-size: 2.5rem; margin-bottom: 1rem; display: block; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: #374151; }
        .card-add-book { background: linear-gradient(135deg, #fdf2f8, #fce7f3); }
        .card-librero { background: linear-gradient(135deg, #f0f9ff, #e0f2fe); }
        .card-clubs { background: linear-gradient(135deg, #eff6ff, #dbeafe); }
        .card-calendar { background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
        .card-quotes { background: linear-gradient(135deg, #f5f3ff, #ede9fe); }
        .card-playlists { background: linear-gradient(135deg, #fef2f2, #fee2e2); }
        .card-tributes { background: linear-gradient(135deg, #fffbeb, #fef3c7); }
        .card-suggestions { background: linear-gradient(135deg, #ecfdf5, #d1fae5); }

        .nav-section { display: none; }
        .nav-section.active { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 2rem; font-weight: 700; color: #374151; text-align: center; flex-grow: 1; }
        .btn { border: none; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .back-btn { background: linear-gradient(135deg, #c7d2fe, #818cf8); color: white; box-shadow: 0 4px 12px rgba(129, 140, 248, 0.3); }
        .add-btn { background: linear-gradient(135deg, #fda4af, #f472b6); color: white; box-shadow: 0 4px 12px rgba(244, 114, 182, 0.3); }

        .librero-tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-btn { background: rgba(255,255,255,0.5); border: 1px solid rgba(229, 231, 235, 0.7); color: #6b7280; &.active { background: var(--purple); color: white; } }
        .tab-content { display: none; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1.5rem; &.active { display: grid; } }
        .book-cover-item { position: relative; cursor: pointer; }
        .book-cover-item img { width: 100%; height: auto; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: all 0.3s ease; background-color: #e5e7eb; }
        .book-cover-item:hover img { transform: scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(240, 242, 247, 0.7); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-backdrop.active { display: flex; }
        .modal-content { background: #ffffff; padding: 2rem; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
        .modal-form h4 { font-size: 1.1rem; color: var(--purple); margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px dashed #e5e7eb; padding-bottom: 0.5rem; }
        .modal-form label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #4b5563; }
        .modal-form input, .modal-form textarea, .modal-form select { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
        .modal-form input:focus, .modal-form textarea:focus, .modal-form select:focus { outline: none; border-color: var(--pink); box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2); }
        .modal-form button[type="submit"] { width: 100%; background: linear-gradient(135deg, var(--purple), var(--pink)); color: white; padding: 1rem; font-size: 1.1rem; }
        
        .star-rating { display: flex; gap: 0.5rem; font-size: 2rem; color: #d1d5db; cursor: pointer; margin-bottom: 1rem; }
        .star-rating .star { transition: color 0.2s; }
        .star-rating .star:hover, .star-rating .star.selected { color: var(--yellow); }
        
        .celebration-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .celeb-item { position: absolute; animation: fall 5s linear forwards; font-size: 2rem; }
        @keyframes fall { 0% { top: -10%; opacity: 1; transform: rotate(0deg) scale(1); } 100% { top: 110%; opacity: 0; transform: rotate(720deg) scale(0.5); } }
        
        .empty-state { text-align: center; padding: 4rem 2rem; color: #6b7280; background: rgba(255,255,255,0.6); border-radius: 24px; grid-column: 1 / -1; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.7; }
        .items-grid { display: grid; gap: 1rem; grid-template-columns: 1fr; }
        .item-card { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 16px rgba(0,0,0,0.05); position: relative; }
        .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: #fee2e2; color: #ef4444; border: none; width: 2rem; height: 2rem; border-radius: 50%; cursor: pointer; transition: all 0.2s; }
        .delete-btn:hover { background: #ef4444; color: white; }
        
        @media (max-width: 768px) {
            .title { font-size: 2.5rem; } .container { padding: 1rem; }
            .grid { grid-template-columns: 1fr; }
            .tab-content.active { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="bg-decoration bg-book-1">üìö</div>
    <div class="bg-decoration bg-butterfly">ü¶ã</div>
    <div id="celebrationContainer" class="celebration-container"></div>

    <div class="container">
        <section id="home" class="nav-section active">
            <header class="header">
                <h1 class="title">Merakelysi</h1>
                <p class="subtitle">By Maribel Alba</p>
            </header>
            <main class="grid">
                <div class="card card-add-book" onclick="openModal('addBookModal')"><span class="card-icon">üìñ</span><h3 class="card-title">Agregar Libro</h3></div>
                <div class="card card-librero" onclick="showSection('librero')"><span class="card-icon">üìö</span><h3 class="card-title">Mi Librero</h3></div>
                <div class="card card-clubs" onclick="showSection('clubs')"><span class="card-icon">üë•</span><h3 class="card-title">Clubes de Lectura</h3></div>
                <div class="card card-calendar" onclick="showSection('calendar')"><span class="card-icon">üìÖ</span><h3 class="card-title">Calendario</h3></div>
                <div class="card card-quotes" onclick="showSection('quotes')"><span class="card-icon">üìù</span><h3 class="card-title">Frases</h3></div>
                <div class="card card-playlists" onclick="showSection('playlists')"><span class="card-icon">üéß</span><h3 class="card-title">Playlists</h3></div>
                <div class="card card-tributes" onclick="showSection('tributes')"><span class="card-icon">‚ú®</span><h3 class="card-title">Homenajes</h3></div>
                <div class="card card-suggestions" onclick="showSection('suggestions')"><span class="card-icon">ü§ñ</span><h3 class="card-title">Sugerencias</h3></div>
            </main>
        </section>

        <section id="librero" class="nav-section">
            <div class="section-header">
                <button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button>
                <h2 class="section-title">Mi Librero</h2>
                <button class="btn add-btn" onclick="openModal('addBookModal')">+ Agregar Libro</button>
            </div>
            <div class="librero-tabs">
                <button id="tab-reading" class="tab-btn active btn" onclick="switchTab('reading')">Leyendo</button>
                <button id="tab-finished" class="tab-btn btn" onclick="switchTab('finished')">Terminados</button>
                <button id="tab-wishlist" class="tab-btn btn" onclick="switchTab('wishlist')">Wishlist</button>
            </div>
            <div id="content-reading" class="tab-content active"></div>
            <div id="content-finished" class="tab-content"></div>
            <div id="content-wishlist" class="tab-content">
                <button class="btn add-btn" onclick="openModal('addWishlistModal')">+ Agregar a Wishlist</button>
            </div>
        </section>

        <section id="clubs" class="nav-section">
            <div class="section-header"><button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button><h2 class="section-title">Clubes</h2><button class="btn add-btn" onclick="openModal('addClubModal')">+ Crear</button></div>
            <div id="clubsContainer" class="items-grid"></div>
        </section>
        <section id="calendar" class="nav-section">
             <div class="section-header"><button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button><h2 class="section-title">Calendario</h2><button class="btn add-btn" onclick="openModal('addEventModal')">+ Evento</button></div>
             <div id="calendarContainer" style="background: rgba(255,255,255,0.7); border-radius: 20px; padding: 1rem; backdrop-filter: blur(5px);"></div>
        </section>
        <section id="quotes" class="nav-section">
             <div class="section-header"><button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button><h2 class="section-title">Frases</h2><button class="btn add-btn" onclick="openModal('addQuoteModal')">+ Nueva</button></div>
             <div id="quotesContainer" class="items-grid"></div>
        </section>
         <section id="playlists" class="nav-section">
             <div class="section-header"><button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button><h2 class="section-title">Playlists</h2><button class="btn add-btn" onclick="openModal('addPlaylistModal')">+ Nueva</button></div>
             <div id="playlistsContainer" class="items-grid"></div>
        </section>
        <section id="tributes" class="nav-section">
             <div class="section-header"><button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button><h2 class="section-title">Homenajes</h2><button class="btn add-btn" onclick="openModal('addTributeModal')">+ Nuevo</button></div>
             <div id="tributesContainer" class="items-grid"></div>
        </section>
         <section id="suggestions" class="nav-section">
             <div class="section-header"><button class="btn back-btn" onclick="showSection('home')">‚Üê Inicio</button><h2 class="section-title">Sugerencias</h2><button class="btn add-btn" id="suggestion-btn" onclick="generateSuggestions()">Generar</button></div>
             <div id="suggestionsContainer" class="tab-content active" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));"></div>
        </section>
    </div>

    <div id="addBookModal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addBookModal')">√ó</button>
            <h3>Agregar/Editar Libro</h3>
            <form id="addBookForm" class="modal-form">
                <input type="hidden" name="id">
                <h4>Informaci√≥n B√°sica</h4>
                <label>T√≠tulo:</label><input type="text" name="title" required>
                <label>Autor/a:</label><input type="text" name="author">
                <label>URL de Portada:</label><input type="url" name="imageUrl" placeholder="https://ejemplo.com/portada.jpg">
                <h4>Estatus y Progreso</h4>
                <label>Estatus:</label>
                <select name="status"><option value="not-started">No Iniciado</option><option value="reading">Leyendo</option><option value="finished">Terminado</option></select>
                <label>P√°gina Actual:</label><input type="number" name="currentPage" value="0" min="0">
                <label>Total de P√°ginas:</label><input type="number" name="totalPages" value="0" min="0">
                <h4>Metas de Lectura</h4>
                <label>Frecuencia:</label>
                <select name="goalType"><option value="">Sin Meta</option><option value="semanal">Semanal</option><option value="quincenal">Quincenal</option><option value="mensual">Mensual</option><option value="anual">Anual</option></select>
                <label>P√°gina Objetivo:</label><input type="number" name="goalTargetPage" min="0" value="0">
                <h4>Calificaci√≥n</h4>
                <div class="star-rating" id="bookRatingStars"><span class="star" data-value="1">‚òÖ</span><span class="star" data-value="2">‚òÖ</span><span class="star" data-value="3">‚òÖ</span><span class="star" data-value="4">‚òÖ</span><span class="star" data-value="5">‚òÖ</span></div>
                <input type="hidden" name="rating" id="bookRatingInput" value="0">
                <h4>Archivos y Enlaces</h4>
                <label>Instagram del Autor:</label><input type="url" name="authorInstagram">
                <label>Facebook del Autor:</label><input type="url" name="authorFacebook">
                <label>URL a PDF:</label><input type="url" name="filePdf">
                <label>URL a EPUB:</label><input type="url" name="fileEpub">
                <label>URL a Audiolibro:</label><input type="url" name="fileAudio">
                <button type="submit" class="btn add-btn">Guardar Libro</button>
                <button type="button" class="btn back-btn" style="margin-top: 1rem; background: var(--green);" onclick="openReviewModal()">‚úçÔ∏è Crear Rese√±a con IA</button>
            </form>
        </div>
    </div>
    
    <div id="addWishlistModal" class="modal-backdrop">
         <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addWishlistModal')">√ó</button>
            <h3>Agregar a Wishlist</h3>
            <form id="addWishlistForm" class="modal-form">
                <input type="hidden" name="id">
                <label>T√≠tulo:</label><input type="text" name="title" required>
                <label>Autor/a:</label><input type="text" name="author">
                <label>URL de Portada:</label><input type="url" name="imageUrl" placeholder="https://ejemplo.com/portada.jpg">
                <button type="submit" class="btn add-btn">Guardar Deseo</button>
            </form>
        </div>
    </div>

    <div id="reviewAiModal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('reviewAiModal')">√ó</button>
            <h3 id="reviewAiTitle">Crear Rese√±a con IA</h3>
            <form id="reviewAiForm" class="modal-form">
                <input type="hidden" name="bookIdForReview">
                <label>¬øQu√© es lo que m√°s te gust√≥ de los personajes?</label><textarea name="q_characters"></textarea>
                <label>Describe la trama en una o dos frases.</label><textarea name="q_plot"></textarea>
                <label>¬øQu√© emociones te provoc√≥ el libro?</label><input type="text" name="q_emotions">
                <label>¬øA qu√© tipo de lector lo recomendar√≠as?</label><input type="text" name="q_recommendation">
                <button type="submit" class="btn add-btn">Generar Borrador</button>
            </form>
        </div>
    </div>

    <div id="generatedReviewModal" class="modal-backdrop">
        <div class="modal-content" style="text-align: center;">
            <button class="modal-close-btn" onclick="closeModal('generatedReviewModal')">√ó</button>
            <h3>Borrador de Rese√±a</h3>
            <div id="generatedReviewText" style="white-space: pre-wrap; background: #f9fafb; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; margin: 1rem 0; text-align: left;"></div>
            <button type="button" class="btn add-btn" onclick="copyReviewText()">Copiar Texto</button>
        </div>
    </div>
    
    <div id="addClubModal" class="modal-backdrop">
        <div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal('addClubModal')">√ó</button>
             <h3>Agregar/Editar Club</h3>
             <form id="addClubForm" class="modal-form">
                <input type="hidden" name="id">
                <label>Nombre del Club:</label><input type="text" name="name" required>
                <label>Descripci√≥n:</label><textarea name="description"></textarea>
                <label>D√≠a de Reuni√≥n:</label><input type="text" name="meetingDay">
                <label>N√∫mero de Lectores:</label><input type="number" name="memberCount" value="0" min="0">
                <label>Libros por Mes:</label><input type="number" name="booksPerMonth" value="1" min="0">
                <button type="submit" class="btn add-btn">Guardar Club</button>
             </form>
        </div>
    </div>

    <div id="addQuoteModal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addQuoteModal')">√ó</button>
            <h3>Frase C√©lebre</h3>
            <form id="addQuoteForm" class="modal-form">
                <input type="hidden" name="id">
                <label>Libro Asociado:</label><select name="bookId"></select>
                <label>Frase:</label><textarea name="text" required></textarea>
                <label>Autor de la frase:</label><input type="text" name="author">
                <button type="submit" class="btn add-btn">Guardar Frase</button>
            </form>
        </div>
    </div>
    
    <div id="addEventModal" class="modal-backdrop">
        <div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal('addEventModal')">√ó</button>
            <h3>Evento del Calendario</h3>
             <form id="addEventForm" class="modal-form">
                <input type="hidden" name="id">
                <label>T√≠tulo del Evento:</label><input type="text" name="title" required>
                <label>Fecha:</label><input type="date" name="date" required>
                <label>Tipo de Evento:</label>
                <select name="eventType">
                    <option value="generic">Gen√©rico</option>
                    <option value="goal">Meta Lectora</option>
                    <option value="finished">Libro Terminado</option>
                    <option value="meeting">Reuni√≥n con Autor</option>
                </select>
                <label>Libro Asociado (opcional):</label><select name="bookId"></select>
                <button type="submit" class="btn add-btn">Guardar Evento</button>
             </form>
        </div>
    </div>

    <div id="addPlaylistModal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addPlaylistModal')">√ó</button>
            <h3>Playlist para un Libro</h3>
            <form id="addPlaylistForm" class="modal-form">
                <input type="hidden" name="id">
                <label>Libro Asociado:</label><select name="bookId" required></select>
                <label>Nombre de la Playlist:</label><input type="text" name="name" required>
                <label>URL de Spotify:</label><input type="url" name="url" placeholder="https://open.spotify.com/..." required>
                <button type="submit" class="btn add-btn">Guardar Playlist</button>
            </form>
        </div>
    </div>
    
    <div id="addTributeModal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addTributeModal')">√ó</button>
            <h3>Homenaje Literario</h3>
            <form id="addTributeForm" class="modal-form">
                <input type="hidden" name="id">
                <label>Libro Asociado:</label><select name="bookId" required></select>
                <label>T√≠tulo del Homenaje:</label><input type="text" name="title" required>
                <label>Notas o Contenido:</label><textarea name="content"></textarea>
                <button type="submit" class="btn add-btn">Guardar Homenaje</button>
            </form>
        </div>
    </div>

<script>
// --- CORE APP LOGIC ---
let data = {};
const initData = { books: [], clubs: [], events: [], quotes: [], wishlist: [], suggestions: [], playlists: [], tributes: [] };
let currentSection = 'home';
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

// --- LIFECYCLE & SETUP ---
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    showSection('home');
    window.addEventListener('beforeunload', saveData);
    document.addEventListener('keydown', e => e.key === 'Escape' && closeAllModals());
    setupAllForms();
});

function loadData() {
    let migrated = false;
    let savedData = localStorage.getItem('merakelysi_data_v3');
    
    if (!savedData) {
        const oldData = localStorage.getItem('merakelysi_data');
        if (oldData) {
            savedData = oldData;
            migrated = true;
        }
    }

    try {
        const parsed = savedData ? JSON.parse(savedData) : {};
        data = { ...initData, ...parsed };
    } catch { data = { ...initData }; }

    if (migrated) {
        data.books.forEach(book => {
            if (book.isFinished && !book.status) book.status = 'finished';
            else if (!book.status) book.status = 'reading';
        });
        saveData();
        alert("¬°Hemos actualizado la aplicaci√≥n y tus datos anteriores se han conservado!");
    }
}
const saveData = () => localStorage.setItem('merakelysi_data_v3', JSON.stringify(data));

function setupAllForms() {
    const forms = { 'addBookForm': 'books', 'addWishlistForm': 'wishlist', 'addClubForm': 'clubs', 'addQuoteForm': 'quotes', 'addEventForm': 'events', 'addPlaylistForm': 'playlists', 'addTributeForm': 'tributes' };
    for (const [formId, dataType] of Object.entries(forms)) {
        const form = document.getElementById(formId);
        if (form) form.addEventListener('submit', (e) => handleGenericSubmit(e, dataType));
    }
    document.getElementById('reviewAiForm').addEventListener('submit', handleReviewAiForm);
    setupStarRating('bookRatingStars', 'bookRatingInput');
}

// --- NAVIGATION & RENDERING ---
const showSection = (sectionId) => {
    document.querySelectorAll('.nav-section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId)?.classList.add('active');
    currentSection = sectionId;
    renderCurrentSection();
};
const switchTab = (tabId) => {
    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tabId}`)?.classList.add('active');
    document.getElementById(`content-${tabId}`)?.classList.add('active');
    if(tabId === 'wishlist') document.getElementById('content-wishlist').insertAdjacentHTML('afterbegin', `<button class="btn add-btn" onclick="openModal('addWishlistModal')">+ Agregar a Wishlist</button>`);
};
function renderCurrentSection() {
    const renderers = { 
        'home': () => {},
        'librero': renderLibrero, 
        'clubs': () => renderList('clubs', 'clubsContainer', clubRenderer, 'üë•', 'Sin clubes'),
        'quotes': () => renderList('quotes', 'quotesContainer', quoteRenderer, 'üìù', 'Sin frases'),
        'playlists': () => renderList('playlists', 'playlistsContainer', playlistRenderer, 'üéß', 'Sin playlists'),
        'tributes': () => renderList('tributes', 'tributesContainer', tributeRenderer, '‚ú®', 'Sin homenajes'),
        'calendar': () => renderCalendar(currentYear, currentMonth),
        'suggestions': renderSuggestions
    };
    renderers[currentSection]?.();
}

function renderLibrero() {
    document.getElementById('content-reading').innerHTML = data.books.filter(b => b.status === 'reading').map(bookToCover).join('') || getEmptyStateHTML('üìñ', 'Nada por aqu√≠');
    document.getElementById('content-finished').innerHTML = data.books.filter(b => b.status === 'finished').map(bookToCover).join('') || getEmptyStateHTML('‚úÖ', 'A√∫n no terminas libros');
    document.getElementById('content-wishlist').innerHTML = data.wishlist.map(wishlistToCover).join('') || getEmptyStateHTML('üíñ', 'Wishlist vac√≠a');
    if (data.wishlist.length === 0) document.getElementById('content-wishlist').insertAdjacentHTML('beforeend', `<div style="grid-column: 1 / -1;"><button class="btn add-btn" onclick="openModal('addWishlistModal')">+ Agregar a Wishlist</button></div>`);
}
const bookToCover = (book) => `<div class="book-cover-item" onclick="openModal('addBookModal', ${book.id})"><img src="${book.imageUrl || 'https://via.placeholder.com/200x300.png?text=Sin+Portada'}" alt="${book.title}" loading="lazy"></div>`;
const wishlistToCover = (book) => `<div class="book-cover-item" onclick="openModal('addWishlistModal', ${book.id})"><img src="${book.imageUrl || 'https://via.placeholder.com/200x300.png?text=Sin+Portada'}" alt="${book.title}" loading="lazy"></div>`;

function renderList(dataType, containerId, renderer, icon, emptyText) {
    const container = document.getElementById(containerId);
    container.innerHTML = data[dataType].length > 0 ? data[dataType].map(renderer).join('') : getEmptyStateHTML(icon, emptyText);
}
const clubRenderer = (club) => `<div class="item-card"><button class="delete-btn" onclick="deleteItem('clubs', ${club.id})">X</button><h3>${club.name}</h3><p>${club.description||''}</p><small>Miembros: ${club.memberCount || 0} | Libros/Mes: ${club.booksPerMonth || 0} | D√≠a: ${club.meetingDay || 'N/A'}</small><br><button class="btn" style="margin-top:1rem;" onclick="openModal('addClubModal', ${club.id})">Editar</button></div>`;
const quoteRenderer = (quote) => {
    const book = data.books.find(b => b.id == quote.bookId);
    return `<div class="item-card"><button class="delete-btn" onclick="deleteItem('quotes', ${quote.id})">X</button><p>"${quote.text}"</p><small>- ${quote.author || (book?.author || 'An√≥nimo')}, en <i>${book?.title||'Libro desconocido'}</i></small><br><button class="btn" style="margin-top:1rem;" onclick="openModal('addQuoteModal', ${quote.id})">Editar</button></div>`
};
const playlistRenderer = (item) => {
    const book = data.books.find(b => b.id == item.bookId);
    return `<div class="item-card"><button class="delete-btn" onclick="deleteItem('playlists', ${item.id})">X</button><h3>${item.name}</h3><p>Para el libro: ${book?.title || 'No especificado'}</p><a href="${item.url}" target="_blank">Escuchar en Spotify</a><br><button class="btn" style="margin-top:1rem;" onclick="openModal('addPlaylistModal', ${item.id})">Editar</button></div>`;
}
const tributeRenderer = (item) => {
    const book = data.books.find(b => b.id == item.bookId);
    return `<div class="item-card"><button class="delete-btn" onclick="deleteItem('tributes', ${item.id})">X</button><h3>${item.title}</h3><p>Homenaje para: ${book?.title || 'No especificado'}</p><p>${item.content||''}</p><button class="btn" style="margin-top:1rem;" onclick="openModal('addTributeModal', ${item.id})">Editar</button></div>`;
}

function renderCalendar(year, month) {
    const container = document.getElementById('calendarContainer');
    if(!container) return;

    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const firstDay = new Date(year, month).getDay();
    const daysInMonth = 32 - new Date(year, month, 32).getDate();

    let gridHTML = Array(firstDay).fill('<div class="calendar-day empty"></div>').join('');
    for (let day = 1; day <= daysInMonth; day++) {
        const dateString = new Date(year, month, day).toISOString().split('T')[0];
        const eventsOnDay = data.events.filter(e => e.date === dateString);
        const book = eventsOnDay.length > 0 ? data.books.find(b => b.id == eventsOnDay[0].bookId) : null;
        let dayClass = 'calendar-day';
        if(eventsOnDay.length > 0) dayClass += ' has-event';
        
        gridHTML += `<div class="${dayClass}" onclick="alert('Funcionalidad de detalle de d√≠a pendiente')">
            <div class="calendar-day-number">${day}</div>
            <div class="calendar-day-events">${eventsOnDay.map(e => `<div>${e.title}</div>`).join('')}</div>
            ${book ? `<img src="${book.imageUrl}" style="width:30px; height: 45px; object-fit: cover; border-radius: 4px; margin-top: 4px;">` : ''}
        </div>`;
    }
    container.innerHTML = `
        <div class="calendar-header">
            <button class="btn back-btn" onclick="prevMonth()">‚Äπ</button>
            <span>${monthNames[month]} ${year}</span>
            <button class="btn back-btn" onclick="nextMonth()">‚Ä∫</button>
        </div>
        <div class="calendar-weekdays">${["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"].map(d=>`<span>${d}</span>`).join('')}</div>
        <div class="calendar-grid">${gridHTML}</div>`;
}
const nextMonth = () => { currentMonth = (currentMonth + 1) % 12; if(currentMonth === 0) currentYear++; renderCalendar(currentYear, currentMonth); };
const prevMonth = () => { currentMonth = (currentMonth - 1 + 12) % 12; if(currentMonth === 11) currentYear--; renderCalendar(currentYear, currentMonth); };

async function generateSuggestions() {
    const container = document.getElementById('suggestionsContainer');
    container.innerHTML = getEmptyStateHTML('‚è≥', 'Buscando...');
    try {
        const response = await fetch(`https://openlibrary.org/subjects/love.json?limit=12`);
        const result = await response.json();
        data.suggestions = result.works.filter(w => w.cover_id).map(w => ({ id: w.key, title: w.title, author: w.authors[0]?.name, imageUrl: `https://covers.openlibrary.org/b/id/${w.cover_id}-M.jpg` }));
        renderSuggestions();
    } catch(e) { container.innerHTML = getEmptyStateHTML('üòû', 'Error al buscar'); }
}
function renderSuggestions() {
    document.getElementById('suggestionsContainer').innerHTML = data.suggestions.map(bookToCover).join('');
}

const getEmptyStateHTML = (icon, title, text = '') => `<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-state-icon">${icon}</div><h3>${title}</h3><p>${text}</p></div>`;

// --- FORM HANDLING ---
function handleGenericSubmit(event, dataType) {
    event.preventDefault();
    const form = event.target;
    const itemData = Object.fromEntries(new FormData(form).entries());
    const id = parseFloat(itemData.id);

    if (dataType === 'books') {
        const oldBook = id ? data.books.find(b => b.id === id) : null;
        if (oldBook && oldBook.status !== 'finished' && itemData.status === 'finished') triggerCelebration('finished');
        if (oldBook && oldBook.goalTargetPage > 0 && parseFloat(oldBook.currentPage) < parseFloat(oldBook.goalTargetPage) && parseFloat(itemData.currentPage) >= parseFloat(oldBook.goalTargetPage)) {
            triggerCelebration('goal');
        }
    }

    if (id) {
        const index = data[dataType].findIndex(item => item.id === id);
        if (index > -1) data[dataType][index] = { ...data[dataType][index], ...itemData, id };
    } else {
        itemData.id = Date.now() + Math.random();
        data[dataType].push(itemData);
    }
    saveData();
    renderCurrentSection();
    if(dataType === 'events') renderCalendar(currentYear, currentMonth);
    closeModal(form.closest('.modal-backdrop').id);
    showSuccess('¬°Guardado!');
}

function deleteItem(dataType, id) {
    if (confirm('¬øSeguro que quieres eliminar este elemento?')) {
        data[dataType] = data[dataType].filter(item => item.id !== id);
        saveData();
        renderCurrentSection();
        showSuccess('Elemento eliminado.');
    }
}

// --- MODALS ---
function openModal(modalId, itemId = null) {
    const modal = document.getElementById(modalId);
    if (!modal) return console.error(`Modal ${modalId} no encontrado`);
    const form = modal.querySelector('form');
    if (form) form.reset();
    
    const starContainer = form ? form.querySelector('.star-rating') : null;
    if (starContainer) updateStarDisplay(starContainer, 0);

    ['addQuoteModal', 'addEventModal', 'addPlaylistModal', 'addTributeModal'].forEach(mId => {
        if(modalId === mId){
            const select = modal.querySelector('select[name="bookId"]');
            if(select) {
                select.innerHTML = '<option value="">-- Selecciona un libro --</option>';
                data.books.forEach(b => select.add(new Option(b.title, b.id)));
            }
        }
    });

    if (itemId) {
        let item;
        const dataMap = { 'addBookModal': data.books, 'addWishlistModal': data.wishlist, 'addClubModal': data.clubs, 'addQuoteModal': data.quotes, 'addEventModal': data.events, 'addPlaylistModal': data.playlists, 'addTributeModal': data.tributes };
        item = dataMap[modalId]?.find(i => i.id === itemId);

        if (item && form) {
            Object.keys(item).forEach(key => { if(form.elements[key]) form.elements[key].value = item[key]; });
            if(item.rating && starContainer) updateStarDisplay(starContainer, item.rating);
        }
    }
    modal.classList.add('active');
}
const closeModal = (modalId) => document.getElementById(modalId)?.classList.remove('active');
const closeAllModals = () => document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('active'));

// --- FEATURES (Stars, AI Review, Celebrations, etc.) ---
function setupStarRating(containerId, inputId) {
    const container = document.getElementById(containerId);
    const input = document.getElementById(inputId);
    if(container && input) container.addEventListener('click', e => {
        if(e.target.matches('.star')) {
            const value = e.target.dataset.value;
            input.value = value;
            updateStarDisplay(container, value);
        }
    });
}
function updateStarDisplay(container, value) {
    container.querySelectorAll('.star').forEach(star => star.classList.toggle('selected', star.dataset.value <= value));
}

function openReviewModal() {
    const form = document.getElementById('addBookForm');
    const bookId = form.elements.id.value;
    const bookTitle = form.elements.title.value;
    if (!bookId) { alert("Primero guarda el libro antes de crear una rese√±a."); return; }
    
    const modal = document.getElementById('reviewAiModal');
    modal.querySelector('#reviewAiTitle').textContent = `Rese√±a para: ${bookTitle}`;
    modal.querySelector('input[name="bookIdForReview"]').value = bookId;
    closeModal('addBookModal');
    openModal('reviewAiModal');
}

function handleReviewAiForm(e) {
    e.preventDefault();
    const answers = Object.fromEntries(new FormData(e.target).entries());
    const book = data.books.find(b => b.id == answers.bookIdForReview);
    const generatedText = `Basado en mi lectura de "${book?.title || 'este libro'}", puedo decir que los personajes son ${answers.q_characters || 'un punto central de la obra'}. La trama, que gira en torno a ${answers.q_plot || 'un conflicto interesante'}, me provoc√≥ sentimientos de ${answers.q_emotions || 'gran expectaci√≥n'}. Recomendar√≠a esta novela a cualquier persona que busque ${answers.q_recommendation || 'una lectura inolvidable'}.`;
    
    document.getElementById('generatedReviewText').textContent = generatedText.trim();
    closeModal('reviewAiModal');
    openModal('generatedReviewModal');
}
const copyReviewText = () => navigator.clipboard.writeText(document.getElementById('generatedReviewText').textContent).then(() => { showSuccess("¬°Rese√±a copiada!"); closeModal('generatedReviewModal'); });

function triggerCelebration(type) {
    const container = document.getElementById('celebrationContainer');
    container.innerHTML = '';
    const items = type === 'finished' ? ['üéâ', 'üéà', 'üìñ', 'üå∏', 'ü¶ã', '‚≠ê'] : ['üëè', '‚ù§Ô∏è', 'üíñ', '‚ú®'];
    for (let i = 0; i < 50; i++) {
        const el = document.createElement('div');
        el.className = 'celeb-item';
        el.textContent = items[Math.floor(Math.random() * items.length)];
        el.style.left = `${Math.random() * 100}vw`;
        el.style.animationDelay = `${Math.random() * 4}s`;
        container.appendChild(el);
    }
    setTimeout(() => container.innerHTML = '', 5000);
}

const showSuccess = (message) => {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.position = 'fixed'; div.style.top = '20px'; div.style.right = '20px';
    div.style.background = 'linear-gradient(135deg, var(--green), #10b981)';
    div.style.color = 'white'; div.style.padding = '1rem 2rem'; div.style.borderRadius = '12px';
    div.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)'; div.style.zIndex = '10001';
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
};
</script>
</body>
</html>
