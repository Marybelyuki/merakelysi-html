<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merakelysi - Mi Universo Literario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- General & Base Styles --- */
        :root {
            --pink: #f472b6;
            --purple: #a855f7;
            --blue: #60a5fa;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --text-primary: #374151;
            --text-secondary: #6b7280;
            --bg-light: rgba(255, 255, 255, 0.8);
            --border-light: rgba(229, 231, 235, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #fdf2f8, #f5f3ff, #ecfdf5);
            min-height: 100vh;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><text y='20' font-size='20'>🦄</text></svg>"), auto;
            position: relative;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* --- Decorative Background Elements --- */
        .bg-decoration {
            position: fixed;
            opacity: 0.07;
            pointer-events: none;
            z-index: 0;
            animation: float 6s ease-in-out infinite;
        }
        .bg-book-1 { top: 10%; left: 5%; font-size: 5rem; animation-duration: 8s; }
        .bg-book-2 { top: 70%; left: 8%; font-size: 3rem; animation-duration: 10s; }
        .bg-butterfly { bottom: 20%; right: 10%; font-size: 6rem; animation: float-butterfly 12s ease-in-out infinite; transition: color 0.5s ease; }
        .bg-star { top: 25%; right: 15%; font-size: 3rem; animation-duration: 12s; }
        .bg-flower { top: 60%; right: 5%; font-size: 4rem; animation-duration: 9s; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* --- Header Styles --- */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            padding: 2.5rem 2rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 10vw, 5rem);
            font-weight: 700;
            background: linear-gradient(to right, var(--pink), var(--purple));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            position: relative;
            text-shadow: 0 2px 15px rgba(168, 85, 247, 0.1);
        }
        .title::before, .title::after {
            position: absolute;
            opacity: 0.8;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .title::before { content: '🌸'; top: -0.5em; right: -0.5em; font-size: 0.5em; animation: pulse 2.5s infinite; }
        .title::after { content: '🦋'; bottom: -0.2em; left: -0.5em; font-size: 0.4em; animation: float 3.5s ease-in-out infinite; }

        .author-attribution { font-size: 1rem; color: var(--purple); font-weight: 600; margin-bottom: 1.5rem; }

        .user-name-input { margin-bottom: 1rem; }
        .user-name-input label { font-size: 1.2rem; color: var(--text-secondary); font-weight: 600; }
        .user-name-input input {
            border: none;
            border-bottom: 2px dashed var(--pink);
            background: none;
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
            width: 220px;
            padding: 0.2rem 0.5rem;
            transition: border-color 0.3s ease;
        }
        .user-name-input input:focus { outline: none; border-bottom-color: var(--purple); }
        
        .status { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .status-dot { width: 8px; height: 8px; background-color: var(--green); border-radius: 50%; animation: pulse-status 2s infinite; }
        .status-text { font-size: 0.8rem; color: #9ca3af; font-weight: 500; }
        
        /* --- General UI Components (Buttons, Cards) --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .card {
            background: var(--bg-light);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.15);
        }
        .card-icon { font-size: 2.5rem; margin-bottom: 1rem; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }

        .btn {
            background: linear-gradient(135deg, var(--pink), #e879f9);
            color: white;
            border: none;
            padding: 0.8rem 1.6rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(244, 114, 182, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(244, 114, 182, 0.3); }
        .btn:active { transform: translateY(0); }

        .back-btn { background: linear-gradient(135deg, #cbd5e1, #94a3b8); }
        .back-btn:hover { box-shadow: 0 8px 16px rgba(148, 163, 184, 0.3); }

        /* --- Section Styles --- */
        .nav-section { display: none; }
        .nav-section.active { display: block; animation: fadeIn 0.5s ease; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .section-title { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        
        .items-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .item-card {
            background: var(--bg-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            word-wrap: break-word;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.12); }
        .item-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
        .item-subtitle { color: var(--text-secondary); font-weight: 500; margin-bottom: 0.75rem; }
        .item-meta { color: var(--purple); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .item-notes { font-size: 0.9rem; color: var(--text-secondary); white-space: pre-wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-light); }
        
        .item-actions { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
        .item-actions button {
            background: #a78bfa; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        .item-actions button:hover { transform: translateY(-1px); }
        .item-actions button.action-edit { background-color: var(--blue); }
        .item-actions button.action-finish { background-color: var(--green); }
        .item-actions button.action-review { background-color: var(--yellow); }
        
        .delete-btn {
            position: absolute; top: 0.75rem; right: 0.75rem; background: #fca5a5; color: white; border: none;
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
            display: flex; justify-content: center; align-items: center; line-height: 1; transition: all 0.2s ease;
        }
        .delete-btn:hover { background: var(--red); transform: scale(1.1) rotate(90deg); }

        /* --- Empty State --- */
        .empty-state {
            text-align: center; padding: 4rem 2rem; color: var(--text-secondary); background: var(--bg-light);
            border-radius: 24px; border: 1px dashed var(--border-light); backdrop-filter: blur(10px);
        }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        
        /* --- Modal & Notification Styles --- */
        .modal-backdrop, #notification-container, #celebration-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000;
            pointer-events: none;
        }
        .modal-backdrop {
            background-color: rgba(245, 243, 255, 0.5);
            backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: all;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f5f3ff); padding: 2.5rem; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; max-width: 550px;
            width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid white;
            transform: scale(0.95); transition: transform 0.3s ease;
            pointer-events: all;
        }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .modal-content h3 { font-size: 1.75rem; font-family: 'Playfair Display', serif; color: var(--text-primary); margin-bottom: 1.5rem; text-align: center; }
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.75rem;
            cursor: pointer; color: #9ca3af; transition: color 0.2s ease, transform 0.2s ease;
        }
        .modal-close-btn:hover { color: var(--red); transform: rotate(90deg); }
        .modal-form label { display: block; margin: 1rem 0 0.5rem; font-weight: 600; color: var(--text-secondary); }
        .modal-form input, .modal-form textarea, .modal-form select {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 1rem; color: var(--text-primary); background-color: #f9fafb;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-form input:focus, .modal-form textarea:focus, .modal-form select:focus {
            outline: none; border-color: var(--pink); box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2);
        }
        .modal-form textarea { min-height: 100px; resize: vertical; }
        .modal-form button[type="submit"] { width: 100%; margin-top: 1.5rem; background: linear-gradient(135deg, var(--purple), var(--pink)); }
        
        .notification {
            position: absolute; top: 20px; right: 20px;
            background: linear-gradient(135deg, var(--green), #34d399);
            color: white; padding: 1rem 1.5rem; border-radius: 12px;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }
        .notification.show { transform: translateX(0); }
        .notification.error { background: linear-gradient(135deg, var(--red), #f87171); }
        
        .goal-message {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--pink), var(--purple));
            color: white; padding: 2rem 3rem; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(168, 85, 247, 0.4);
            font-size: 1.5rem; font-weight: 700; text-align: center;
            opacity: 0; animation: popInAndOut 3.5s ease-out forwards;
            display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
        }
        .goal-message span { font-size: 2.5rem; }

        .confetti {
            position: absolute; width: 10px; height: 10px; border-radius: 50%;
            animation: fall 3s linear forwards;
        }

        /* --- Animations --- */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        @keyframes float-butterfly { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.07; transform: scale(1); } 50% { opacity: 0.12; transform: scale(1.08); } }
        @keyframes pulse-status { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popInAndOut {
            0%, 100% { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
            20%, 80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes fall {
            from { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .section-header { flex-direction: column; align-items: stretch; text-align: center; }
            .items-grid { grid-template-columns: 1fr; }
            .user-name-input input { width: 180px; }
        }
    </style>
</head>
<body>

    <div class="bg-decoration bg-book-1">📚</div>
    <div class="bg-decoration bg-book-2">📖</div>
    <div class="bg-decoration bg-butterfly">🦋</div>
    <div class="bg-decoration bg-star">✨</div>
    <div class="bg-decoration bg-flower">🌸</div>

    <div class="container">
        <section id="home" class="nav-section">
            <header class="header">
                <h1 class="title">Merakelysi</h1>
                <p class="author-attribution">By Maribel Alba</p>
                <div class="user-name-input">
                    <label for="userName">Hola, </label>
                    <input type="text" id="userName" placeholder="tu nombre aquí">
                </div>
                <div class="status">
                    <div class="status-dot"></div>
                    <span class="status-text">Datos guardados en tu navegador</span>
                </div>
            </header>

            <main id="homeGrid" class="grid">
                </main>
        </section>

        <section id="books" class="nav-section"></section>
        <section id="clubs" class="nav-section"></section>
        <section id="calendar" class="nav-section"></section>
        <section id="quotes" class="nav-section"></section>
        <section id="wishlist" class="nav-section"></section>
        <section id="bookReviews" class="nav-section"></section>
        <section id="generalReviews" class="nav-section"></section>
        <section id="playlists" class="nav-section"></section>
        <section id="diary" class="nav-section"></section>
        <section id="progress" class="nav-section"></section>
        <section id="challenges" class="nav-section"></section>
        <section id="tributes" class="nav-section"></section>
        <section id="stats" class="nav-section"></section>
        <section id="monthly" class="nav-section"></section>
        <section id="finished" class="nav-section"></section>
        <section id="favorites" class="nav-section"></section>
        <section id="suggestions" class="nav-section"></section>
    </div>

    <div id="modal-container"></div>
    
    <div id="notification-container"></div>
    <div id="celebration-container"></div>

<script>
// ===================================================================================
// MERAKELYSI APP 2.0 - CÓDIGO REFACTORIZADO Y MEJORADO
// ===================================================================================

/**
 * Módulo de Configuración y Estado Global
 * Centraliza las constantes y el estado de la aplicación.
 */
const config = {
    storageKey: 'merakelysi_data_v2',
    userNameKey: 'merakelysi_userName_v2',
    pastelColors: ['#FFB6C1', '#87CEEB', '#98FB98', '#DDA0DD', '#F0E68C', '#FFA07A', '#a855f7', '#3b82f6', '#f472b6'],
    sections: [
        { id: 'books', title: 'Mis Libros por Leer', icon: '📚' },
        { id: 'finished', title: 'Lecturas Terminadas', icon: '✅' },
        { id: 'clubs', title: 'Mis Clubes de Lectura', icon: '👥' },
        { id: 'calendar', title: 'Calendario de Lecturas', icon: '📅' },
        { id: 'quotes', title: 'Frases de Lecturas', icon: '📝' },
        { id: 'wishlist', title: 'Wishlist de Libros', icon: '💖' },
        { id: 'bookReviews', title: 'Reseñas Detalladas', icon: '🖋️' },
        { id: 'generalReviews', title: 'Reseñas Generales', icon: '✍️' },
        { id: 'playlists', title: 'Playlists de Lectura', icon: '🎧' },
        { id: 'diary', title: 'Diario de Lectura', icon: '📓' },
        { id: 'progress', title: 'Metas y Progreso', icon: '📈' },
        { id: 'challenges', title: 'Retos Lectores', icon: '🧩' },
        { id: 'tributes', title: 'Homenajes Literarios', icon: '✨' },
        { id: 'favorites', title: 'Favoritos del Año', icon: '🌟' },
        { id: 'suggestions', title: 'Sugerencias Mágicas', icon: '🤖' },
    ]
};

const state = {
    currentSection: 'home',
    userName: '',
    db: {}
};

/**
 * Módulo de Almacenamiento (Storage)
 * Maneja la carga y guardado de datos en el localStorage del navegador.
 */
const storage = {
    save() {
        try {
            localStorage.setItem(config.storageKey, JSON.stringify(state.db));
            console.log('✅ Datos guardados');
        } catch (error) {
            console.error('❌ Error al guardar datos:', error);
            ui.showNotification('Error al guardar los datos.', 'error');
        }
    },
    load() {
        const emptyDB = Object.fromEntries(config.sections.map(s => [s.id, []]));
        try {
            const savedData = localStorage.getItem(config.storageKey);
            if (!savedData) {
                state.db = emptyDB;
                return;
            }
            const parsedData = JSON.parse(savedData);
            for (const key in emptyDB) {
                state.db[key] = parsedData[key] || emptyDB[key];
            }
            // Aseguramos la integridad de los datos de libros
            if (state.db.books) {
                 state.db.books = state.db.books.map(book => ({
                    isFinished: false, notes: '', clubId: null, review: null,
                    ...book
                }));
            }
            console.log('📂 Datos cargados y validados.');
        } catch (error) {
            console.error('❌ Error al cargar datos:', error);
            state.db = emptyDB;
        }
    },
    loadUserName() {
        state.userName = localStorage.getItem(config.userNameKey) || '';
        document.getElementById('userName').value = state.userName;
    },
    saveUserName() {
        state.userName = document.getElementById('userName').value.trim();
        localStorage.setItem(config.userNameKey, state.userName);
    }
};

/**
 * Módulo de la Interfaz de Usuario (UI)
 * Controla la navegación, renderizado de secciones y notificaciones.
 */
const ui = {
    renderSection(sectionId) {
        document.querySelectorAll('.nav-section').forEach(s => s.classList.remove('active'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            state.currentSection = sectionId;
            if (sectionId !== 'home') {
                this.renderPage(sectionId);
            }
        }
    },

    renderPage(sectionId) {
        const sectionConfig = config.sections.find(s => s.id === sectionId);
        if (!sectionConfig) return;

        const sectionElement = document.getElementById(sectionId);
        sectionElement.innerHTML = ''; // Limpiar sección
        sectionElement.appendChild(this.createSectionHeader(sectionConfig));
        
        const container = document.createElement('div');
        container.id = `${sectionId}Container`;
        container.className = sectionConfig.id === 'calendar' ? '' : 'items-grid';
        sectionElement.appendChild(container);

        if (typeof rendering[sectionId] === 'function') {
            rendering[sectionId](container);
        } else {
            rendering.default(container, sectionConfig);
        }
    },
    
    createSectionHeader(sectionConfig) {
        const header = document.createElement('div');
        header.className = 'section-header';
        
        const backBtn = document.createElement('button');
        backBtn.className = 'btn back-btn';
        backBtn.textContent = '← Inicio';
        backBtn.onclick = () => ui.renderSection('home');
        
        const title = document.createElement('h2');
        title.className = 'section-title';
        title.textContent = sectionConfig.title;

        header.appendChild(backBtn);
        header.appendChild(title);

        const addButtonInfo = {
            'books': { label: 'Agregar Libro', modal: 'addBookModal' },
            'clubs': { label: 'Crear Club', modal: 'addClubModal' },
            // ... agregar configuraciones para otros botones de "añadir" aquí
        };
        
        const btnInfo = addButtonInfo[sectionConfig.id];
        if (btnInfo) {
            const addBtn = document.createElement('button');
            addBtn.className = 'btn';
            addBtn.textContent = `+ ${btnInfo.label}`;
            addBtn.onclick = () => modals.open(btnInfo.modal);
            header.appendChild(addBtn);
        }
        
        return header;
    },

    createHomeMenu() {
        const grid = document.getElementById('homeGrid');
        grid.innerHTML = config.sections.map(section => `
            <div class="card" onclick="ui.renderSection('${section.id}')">
                <div class="card-icon">${section.icon}</div>
                <h3 class="card-title">${section.title}</h3>
            </div>
        `).join('');
    },
    
    showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        container.appendChild(notif);
        
        // Forzar reflow para que la animación funcione
        requestAnimationFrame(() => {
            notif.classList.add('show');
        });

        setTimeout(() => {
            notif.classList.remove('show');
            notif.addEventListener('transitionend', () => notif.remove());
        }, 3000);
    },
    // Aquí irían más funciones de UI como showCelebration...
};


/**
 * Módulo de Renderizado de Contenido
 * Contiene funciones para generar el HTML de cada tipo de item.
 */
const rendering = {
    // Función para renderizar la sección de libros
    books(container) {
        const booksInProgress = state.db.books.filter(book => !book.isFinished);
        if (booksInProgress.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📚</div><h3>No hay libros en progreso.</h3><p>¡Agrega un nuevo libro para empezar!</p></div>`;
            return;
        }
        
        container.innerHTML = booksInProgress.map(book => {
            const clubName = book.clubId ? state.db.clubs.find(c => c.id == book.clubId)?.name : '';
            return `
            <div class="item-card">
                <button class="delete-btn" onclick="app.deleteItem('books', ${book.id})">×</button>
                <div class="item-content">
                    <h3 class="item-title">${book.title}</h3>
                    <p class="item-subtitle">por ${book.author}</p>
                    ${clubName ? `<p class="item-meta">👥 ${clubName}</p>` : ''}
                    <div class="item-actions">
                         <button class="action-edit" onclick="modals.open('addBookModal', ${book.id})">Editar</button>
                         <button class="action-finish" onclick="app.markBookAsFinished(${book.id})">✅ Terminar</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    },
    
    // Función de renderizado por defecto para secciones en construcción
    default(container, sectionConfig) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">${sectionConfig.icon}</div>
                <h3>Sección "${sectionConfig.title}"</h3>
                <p>Esta sección está en construcción.</p>
            </div>`;
    }
    // ... aquí irían las demás funciones para renderizar clubes, frases, etc.
};


/**
 * Módulo de Modales
 * Lógica para abrir, cerrar y gestionar los datos de los modales.
 */
const modals = {
    open(modalId, itemId = null) {
        // Esta función ahora construiría el HTML del modal y lo añadiría al DOM
        // Por ahora, asumiremos que el HTML está en el body y solo lo mostraremos
        const modalEl = document.getElementById(modalId); // Asumiendo que el HTML del modal existe
        if (modalEl) {
            // Lógica para rellenar el formulario si es una edición
            const form = modalEl.querySelector('form');
            form.reset();
            form.querySelector('input[type="hidden"]').value = itemId || '';
            // ...
            modalEl.classList.add('active');
            document.body.classList.add('modal-open');
        } else {
             // Crear el HTML del modal dinámicamente aquí
             console.error("La creación dinámica de modales no está implementada en este ejemplo.");
        }
    },
    closeAll() {
        document.querySelectorAll('.modal-backdrop.active').forEach(modal => {
            modal.classList.remove('active');
        });
        document.body.classList.remove('modal-open');
    },
    // Aquí iría el código HTML de cada modal como plantillas de string
    init() {
        const modalContainer = document.getElementById('modal-container');
        // Aquí se crearía el HTML para todos los modales y se insertaría en el contenedor
        // Ejemplo para el modal de libros:
        modalContainer.innerHTML = `
            <div id="addBookModal" class="modal-backdrop">
                <div class="modal-content">
                    <button class="modal-close-btn" onclick="modals.closeAll()">×</button>
                    <h3>Agregar/Editar Libro</h3>
                    <form id="addBookForm">
                        <input type="hidden" name="id">
                        <label for="bookTitle">Título:</label>
                        <input type="text" id="bookTitle" name="title" required>
                        <label for="bookAuthor">Autor/a:</label>
                        <input type="text" id="bookAuthor" name="author" required>
                        <button type="submit" class="btn">Guardar Libro</button>
                    </form>
                </div>
            </div>
            <div id="addClubModal" class="modal-backdrop">
                 <div class="modal-content">
                     <button class="modal-close-btn" onclick="modals.closeAll()">×</button>
                     <h3>Crear/Editar Club</h3>
                     <form id="addClubForm">
                         <input type="hidden" name="id">
                         <label for="clubName">Nombre del Club:</label>
                         <input type="text" id="clubName" name="name" required>
                         <button type="submit" class="btn">Guardar Club</button>
                     </form>
                 </div>
            </div>
        `;
    }
};

/**
 * Módulo Principal de la Aplicación (App)
 * Orquesta los demás módulos y maneja la lógica de negocio.
 */
const app = {
    init() {
        // Inicializa el estado y la UI
        storage.load();
        storage.loadUserName();
        modals.init();
        ui.createHomeMenu();
        ui.renderSection('home');
        
        // Añade event listeners globales
        document.getElementById('userName').addEventListener('change', storage.saveUserName);
        window.addEventListener('beforeunload', storage.save);
        document.addEventListener('keydown', (e) => e.key === 'Escape' && modals.closeAll());
        document.getElementById('modal-container').addEventListener('submit', (e) => {
            if (e.target.tagName === 'FORM') this.handleFormSubmit(e);
        });
        
        console.log("🦄 Merakelysi App 2.0 inicializada.");
    },

    deleteItem(sectionKey, itemId) {
        if (confirm('¿Estás segura de que quieres eliminar este elemento?')) {
            state.db[sectionKey] = state.db[sectionKey].filter(item => item.id != itemId);
            storage.save();
            ui.renderPage(sectionKey);
            ui.showNotification('Elemento eliminado.', 'success');
        }
    },

    handleFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const sectionId = form.id.replace('add', '').replace('Form', '').toLowerCase();
        const sectionKey = sectionId + 's';
        
        const formData = new FormData(form);
        const itemData = Object.fromEntries(formData.entries());
        
        if (itemData.id) { // Editar
            const index = state.db[sectionKey].findIndex(item => item.id == itemData.id);
            if (index > -1) state.db[sectionKey][index] = { ...state.db[sectionKey][index], ...itemData };
        } else { // Agregar
            itemData.id = Date.now();
            state.db[sectionKey].push(itemData);
        }
        
        storage.save();
        ui.renderPage(sectionId);
        modals.closeAll();
        ui.showNotification('¡Guardado con éxito!', 'success');
    },

    markBookAsFinished(bookId) {
        const book = state.db.books.find(b => b.id == bookId);
        if (book && confirm(`¿Marcar "${book.title}" como terminado?`)) {
            book.isFinished = true;
            storage.save();
            ui.renderPage('books');
            // ui.showCelebration(...); // Implementar la celebración aquí
        }
    },
};

// -----------------------------------------------------------------------------------
// INICIALIZACIÓN
// -----------------------------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
