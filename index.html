    <script>
        const pastelColors = ['#FFB6C1', '#87CEEB', '#98FB98', '#DDA0DD', '#F0E68C', '#FFA07A', '#a855f7', '#3b82f6', '#f472b6', '#fde68a', '#ccfbf1', '#bfdbfe'];

        // Estructura de datos principal de la aplicaci√≥n
        let data = {
            userName: '',
            books: [],
            clubs: [],
            events: [],
            quotes: [],
            wishlist: [],
            generalReviews: [],
            playlists: [],
            diary: [],
            goals: [],
            challenges: [],
            tributes: [],
            favorites: [],
            suggestions: []
        };

        let currentSection = 'home';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const today = new Date();
        today.setHours(0,0,0,0);

        const generateUniqueId = () => Date.now() + Math.random();

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderCurrentSection();
            window.addEventListener('beforeunload', saveData);
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeAllModals();
                }
            });
            setupModalForms();
            loadUserName();
            console.log('ü¶Ñ Merakelysi cargado');
            if (data.books.length === 0 && data.suggestions.length === 0) {
                generateSuggestions();
            }
            setRandomButterflyColor();
            setInterval(setRandomButterflyColor, 5000);
        });

        // --- FUNCIONES B√ÅSICAS Y DE NAVEGACI√ìN ---

        function saveData() {
            try {
                localStorage.setItem('merakelysi_data', JSON.stringify(data));
                console.log('‚úÖ Datos guardados');
                return true;
            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                return false;
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('merakelysi_data');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    const defaultData = {
                        books: [], clubs: [], events: [], quotes: [], wishlist: [],
                        generalReviews: [], playlists: [], diary: [], goals: [],
                        challenges: [], tributes: [], favorites: [], suggestions: []
                    };
                    // Carga segura: combina los datos guardados con la estructura por defecto
                    data = { ...defaultData, ...parsed };
                    console.log('üìÇ Datos cargados');
                } else {
                    console.log('üÜï No se encontraron datos guardados, iniciando vac√≠o.');
                }
                loadUserName();
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                // No mostramos alert aqu√≠ para evitar el problema original. El error ya se ve en la consola.
            }
        }
        
        function loadUserName() {
            const savedName = localStorage.getItem('merakelysi_userName');
            if (savedName) {
                data.userName = savedName;
                const userNameInput = document.getElementById('userName');
                if(userNameInput) userNameInput.value = savedName;
            }
        }
        
        function saveUserName() {
            const userNameInput = document.getElementById('userName');
            if(userNameInput) {
               data.userName = userNameInput.value.trim();
               localStorage.setItem('merakelysi_userName', data.userName);
               showSuccess('¬°Nombre guardado!');
            }
        }

        function showSection(sectionId) {
            saveData();
            document.querySelectorAll('.nav-section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                currentSection = sectionId;
                renderCurrentSection();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showSection('home');
            }
        }

        function renderCurrentSection() {
            console.log(`üîÑ Renderizando secci√≥n: ${currentSection}`);
            setRandomSectionFlowerColor();
            switch (currentSection) {
                case 'home': break;
                case 'books': renderBooks(); break;
                case 'clubs': renderClubs(); break;
                case 'calendar': renderCalendar(currentYear, currentMonth); break;
                case 'quotes': renderQuotes(); break;
                case 'wishlist': renderWishlist(); break;
                case 'generalReviews': renderGeneralReviews(); break;
                case 'bookReviews': renderBookReviews(); break;
                case 'playlists': renderPlaylists(); break;
                case 'diary': renderDiary(); break;
                case 'progress': renderProgress(); break;
                case 'challenges': renderChallenges(); break;
                case 'tributes': renderTributes(); break;
                case 'finished': renderFinished(); break;
                case 'favorites': renderFavorites(); break;
                case 'suggestions': renderSuggestions(); break;
                default: showSection('home');
            }
        }
        
        function setRandomButterflyColor() {
             const butterflyElement = document.querySelector('.bg-butterfly');
             if (butterflyElement) {
                 const randomColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
                 butterflyElement.style.color = randomColor;
             }
         }

         function setRandomSectionFlowerColor() {
             const activeSection = document.getElementById(currentSection);
             if (activeSection) {
                 const flowerElement = activeSection.querySelector('.header-flower-decoration');
                 if (flowerElement) {
                     const randomColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
                     flowerElement.style.color = randomColor;
                     const backButton = activeSection.querySelector('.back-btn');
                     flowerElement.classList.toggle('left', !backButton);
                 }
             }
         }

        // --- TODAS LAS FUNCIONES DE RENDERIZADO ---

        function renderBooks() {
            const container = document.getElementById('booksContainer');
            if (!container) return;
            const booksInProgress = data.books.filter(book => !book.isFinished);
            if (booksInProgress.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìö</div><h3>¬°Agrega tu primer libro!</h3><p>Haz clic en "Agregar Libro" para comenzar.</p></div>`;
                return;
            }
            container.innerHTML = booksInProgress.map(book => {
                const progress = book.totalPages > 0 ? `P√°gina ${book.currentPage || 0} / ${book.totalPages}` : `Cap√≠tulo ${book.currentChapter || 0} / ${book.totalChapters || '?'}`;
                return `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('books', ${book.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${book.title}</h3>
                        <p class="item-subtitle">por ${book.author}</p>
                        <p class="item-meta">${progress}</p>
                        <div class="item-actions">
                             <button class="action-edit" onclick="openModal('addBookModal', ${book.id})">Editar</button>
                             <button class="action-finish" onclick="markFinished(${book.id})">‚úÖ Terminado</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderFinished() {
            const container = document.getElementById('finishedContainer');
            if (!container) return;
            const booksFinished = data.books.filter(book => book.isFinished);
            if (booksFinished.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><h3>A√∫n no has terminado ning√∫n libro.</h3><p>¬°Sigue leyendo!</p></div>`;
                return;
            }
            container.innerHTML = booksFinished.map(book => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('books', ${book.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">‚úÖ ${book.title}</h3>
                        <p class="item-subtitle">por ${book.author}</p>
                        <p class="item-meta">¬°Completado!</p>
                        <div class="item-actions">
                             <button class="action-review" onclick="openModal('addDetailedBookReviewModal', ${book.id})">Escribir Rese√±a</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        function renderClubs() {
            const container = document.getElementById('clubsContainer');
            if (!container) return;
            if (data.clubs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üë•</div><h3>¬°Crea tu primer club de lectura!</h3><p>Organiza tus grupos y lecturas compartidas.</p></div>`;
                return;
            }
            container.innerHTML = data.clubs.map(club => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('clubs', ${club.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${club.name}</h3>
                        <p class="item-subtitle">${club.description || 'Sin descripci√≥n'}</p>
                        <p class="item-meta">üìÖ ${club.meetingDay} a las ${club.meetingTime}</p>
                        <p style="margin-top: 1rem; color: #6b7280; font-size: 0.9rem;">üë• ${club.members || 0} miembros</p>
                        <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addClubModal', ${club.id})">Editar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCalendar(year, month) {
            const container = document.getElementById('calendarContainer');
            if (!container) return;
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const dayNames = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];
            const date = new Date(year, month, 1);
            let calendarHtml = `<div class="calendar-header"><button onclick="changeMonth(-1)" class="back-btn">‚Üê</button><span>${monthNames[month]} ${year}</span><button onclick="changeMonth(1)" class="back-btn">‚Üí</button></div><div class="calendar-weekdays">${dayNames.map(day => `<span>${day}</span>`).join('')}</div><div class="calendar-grid">`;
            const firstDayOfWeek = (date.getDay() + 6) % 7;
            for (let i = 0; i < firstDayOfWeek; i++) { calendarHtml += `<div class="calendar-day empty"></div>`; }
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDayDate = new Date(year, month, day);
                const isToday = currentDayDate.toDateString() === new Date().toDateString();
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const eventsToday = data.events.filter(event => event.date === dateString);
                calendarHtml += `<div class="calendar-day ${isToday ? 'today' : ''} ${eventsToday.length > 0 ? 'has-event' : ''}" onclick="showDayEvents('${dateString}')"><span class="calendar-day-number">${day}</span>${eventsToday.map(e => `<div class="calendar-day-events">${e.title}</div>`).join('')}</div>`;
            }
             const totalCells = firstDayOfWeek + daysInMonth;
             const remainingCellsToFill = (6 * 7) - totalCells;
             for (let i = 1; i <= remainingCellsToFill; i++) {
                  calendarHtml += `<div class="calendar-day empty next-month">${i}</div>`;
             }
            container.innerHTML = calendarHtml + '</div>';
        }

        function renderQuotes() {
            const container = document.getElementById('quotesContainer');
            if (!container) return;
            if (data.quotes.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìù</div><h3>Guarda tus frases favoritas</h3><p>Esas palabras que te marcaron merecen un lugar especial.</p></div>`;
                return;
            }
            container.innerHTML = data.quotes.map(quote => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('quotes', ${quote.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">"${quote.text}"</h3>
                        <p class="item-subtitle">‚Äî ${quote.author}</p>
                        ${quote.book ? `<p class="item-meta">${quote.book}</p>` : ''}
                        <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addQuoteModal', ${quote.id})">Editar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderWishlist() {
            const container = document.getElementById('wishlistContainer');
            if (!container) return;
            if (data.wishlist.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üíñ</div><h3>Tu lista de deseos est√° vac√≠a</h3><p>A√±ade aqu√≠ los libros que sue√±as con leer.</p></div>`;
                return;
            }
            container.innerHTML = data.wishlist.map(item => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('wishlist', ${item.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${item.title}</h3>
                        <p class="item-subtitle">por ${item.author || 'Autor/a desconocido/a'}</p>
                        <p class="item-meta">Prioridad: ${item.priority || 'Media'}</p>
                        ${item.reason ? `<p style="margin-top:1rem;font-size:0.9rem;color:#6b7280;">${item.reason}</p>` : ''}
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addWishModal', ${item.id})">Editar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderGeneralReviews() {
            const container = document.getElementById('generalReviewsContainer');
            if (!container) return;
            if (data.generalReviews.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚úçÔ∏è</div><h3>Escribe tu primera rese√±a</h3><p>Comparte tu opini√≥n sobre libros, pel√≠culas o lo que quieras.</p></div>`;
                return;
            }
            container.innerHTML = data.generalReviews.map(review => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('generalReviews', ${review.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${review.book}</h3>
                        <p class="item-subtitle">${'‚≠ê'.repeat(review.rating)} (${review.rating}/5)</p>
                        <p style="margin-top:1rem;font-size:0.9rem;color:#4b5563;white-space:pre-wrap;">${review.content}</p>
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addGeneralReviewModal', ${review.id})">Editar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderBookReviews() {
            const container = document.getElementById('bookReviewsContainer');
            if (!container) return;
            const booksWithReviews = data.books.filter(book => book.review && book.isFinished);
            if (booksWithReviews.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üñãÔ∏è</div><h3>A√∫n no hay rese√±as detalladas</h3><p>Termina un libro y a√±ade una rese√±a para verla aqu√≠.</p></div>`;
                return;
            }
            container.innerHTML = booksWithReviews.map(book => `
                <div class="book-review-card">
                     <button class="delete-btn" onclick="deleteDetailedReview(${book.id})">√ó</button>
                    <div class="item-content">
                        <h3>Rese√±a de: ${book.title}</h3>
                        <p class="item-subtitle">por ${book.author}</p>
                        <div class="review-section"><h4>Calificaci√≥n:</h4><div class="rating-hearts">${'üíñ'.repeat(book.review.rating || 0)}</div></div>
                        ${book.review.likedMost ? `<div class="review-section"><h4>Lo que m√°s me gust√≥:</h4><p>${book.review.likedMost}</p></div>` : ''}
                        ${book.review.quotes ? `<div class="review-section"><h4>Frases Favoritas:</h4><p>${book.review.quotes}</p></div>` : ''}
                        <div class="item-actions"><button class="action-edit" onclick="openModal('addDetailedBookReviewModal', ${book.id})">Editar Rese√±a</button></div>
                    </div>
                </div>
            `).join('');
        }

        function renderPlaylists() {
            const container = document.getElementById('playlistsContainer');
            if (!container) return;
            if (data.playlists.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üéß</div><h3>Crea una playlist</h3><p>Asocia m√∫sica a tus lecturas para una experiencia inmersiva.</p></div>`;
                return;
            }
            container.innerHTML = data.playlists.map(playlist => {
                let embedHtml = '<p>No hay c√≥digo de Spotify.</p>';
                if (playlist.embedCode) {
                    if (playlist.embedCode.includes('open.spotify.com')) {
                        const url = new URL(playlist.embedCode);
                        const path = url.pathname;
                        embedHtml = `<iframe style="border-radius:12px" src="https://open.spotify.com/embed${path}?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                    } else {
                        embedHtml = playlist.embedCode;
                    }
                }
                return `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('playlists', ${playlist.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${playlist.name}</h3>
                        <p class="item-subtitle">${playlist.book || 'Sin libro asociado'}</p>
                        <div style="margin-top:1rem;">${embedHtml}</div>
                        <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addPlaylistModal', ${playlist.id})">Editar</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderDiary() {
            const container = document.getElementById('diaryContainer');
            if (!container) return;
            const sortedDiary = [...data.diary].sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedDiary.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìì</div><h3>Tu diario est√° en blanco</h3><p>Escribe tus reflexiones sobre lo que lees cada d√≠a.</p></div>`;
                return;
            }
            container.innerHTML = sortedDiary.map(entry => {
                const entryDate = entry.date ? new Date(entry.date + 'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric'}) : 'Sin fecha';
                return `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('diary', ${entry.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${entryDate}</h3>
                        <p class="item-subtitle">${entry.book ? `Sobre: ${entry.book}` : 'Reflexi√≥n general'}</p>
                        <p style="margin-top:1rem;font-size:0.9rem;color:#4b5563;white-space:pre-wrap;">${entry.content}</p>
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addDiaryModal', ${entry.id})">Editar</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderProgress() {
            const container = document.getElementById('progressContainer');
            if (!container) return;
            if (data.goals.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìà</div><h3>Define tus metas</h3><p>Ponte retos de lectura, como leer X libros al mes.</p></div>`;
                return;
            }
            container.innerHTML = data.goals.map(goal => {
                const percentage = goal.target > 0 ? (goal.current / goal.target) * 100 : 0;
                return `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('goals', ${goal.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${goal.title}</h3>
                        <p class="item-subtitle">${goal.description || ''}</p>
                        <p class="item-meta">Progreso: ${goal.current} / ${goal.target}</p>
                        <div style="background-color:#e5e7eb; border-radius:10px; overflow:hidden; margin-top:1rem;">
                            <div style="width:${percentage}%; background:linear-gradient(to right, #a855f7, #f472b6); height:10px; border-radius:10px;"></div>
                        </div>
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addGoalModal', ${goal.id})">Editar</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderChallenges() {
            const container = document.getElementById('challengesContainer');
            if (!container) return;
            if (data.challenges.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üß©</div><h3>Acepta un reto</h3><p>Encuentra y participa en retos de lectura para descubrir nuevos g√©neros.</p></div>`;
                return;
            }
            container.innerHTML = data.challenges.map(challenge => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('challenges', ${challenge.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${challenge.title}</h3>
                        <p class="item-subtitle">Categor√≠a: ${challenge.category || 'General'}</p>
                        <p style="margin-top:1rem;font-size:0.9rem;color:#6b7280;">${challenge.description}</p>
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addChallengeModal', ${challenge.id})">Editar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTributes() {
            const container = document.getElementById('tributesContainer');
            if (!container) return;
            if (data.tributes.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ú®</div><h3>Crea un homenaje</h3><p>Dedica un espacio a ese libro o autor que te cambi√≥ la vida.</p></div>`;
                return;
            }
            container.innerHTML = data.tributes.map(tribute => {
                let contentHtml = '';
                switch(tribute.type) {
                    case 'image': contentHtml = `<img src="${tribute.content}" alt="${tribute.title}" style="max-width:100%; border-radius:12px;">`; break;
                    case 'video': contentHtml = `<iframe width="100%" height="315" src="${tribute.content.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe>`; break;
                    case 'link': contentHtml = `<a href="${tribute.content}" target="_blank" rel="noopener noreferrer">${tribute.content}</a>`; break;
                    default: contentHtml = `<p style="white-space:pre-wrap;">${tribute.content}</p>`;
                }
                return `
                <div class="item-card tribute-item">
                    <button class="delete-btn" onclick="deleteItem('tributes', ${tribute.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${tribute.title}</h3>
                        <div class="tribute-content">${contentHtml}</div>
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addTributeModal', ${tribute.id})">Editar</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesContainer');
            if (!container) return;
            if (data.favorites.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üåü</div><h3>Elige tus favoritos del a√±o</h3><p>Destaca aqu√≠ los libros que m√°s te han gustado.</p></div>`;
                return;
            }
            container.innerHTML = data.favorites.map(fav => `
                <div class="item-card">
                    <button class="delete-btn" onclick="deleteItem('favorites', ${fav.id})">√ó</button>
                    <div class="item-content">
                        <h3 class="item-title">${fav.title}</h3>
                        <p class="item-subtitle">por ${fav.author || 'Autor/a desconocido/a'}</p>
                        <p class="item-meta">${'üåü'.repeat(fav.rating)}</p>
                        ${fav.reason ? `<p style="margin-top:1rem;font-size:0.9rem;color:#6b7280;">${fav.reason}</p>` : ''}
                         <div class="item-actions">
                            <button class="action-edit" onclick="openModal('addFavoriteModal', ${fav.id})">Editar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderSuggestions() {
            const container = document.getElementById('suggestionsContainer');
            if (!container) return;
            if (data.suggestions.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ü§ñ</div><h3>Genera sugerencias</h3><p>Haz clic en el bot√≥n para obtener recomendaciones de lectura.</p></div>`;
                return;
            }
            container.innerHTML = data.suggestions.map(sug => `
                <div class="item-card">
                    <div class="item-content">
                        <h3 class="item-title">${sug.title}</h3>
                        <p class="item-subtitle">por ${sug.author}</p>
                        <p class="item-meta">${sug.genre}</p>
                        <p style="margin-top:1rem;font-size:0.9rem;color:#6b7280;">${sug.reason}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- MANEJO DE FORMULARIOS Y MODALES ---

        function setupModalForms() {
            const formMap = {
                'addBookForm': 'books', 'addClubForm': 'clubs', 'addEventForm': 'events',
                'addQuoteForm': 'quotes', 'addWishForm': 'wishlist', 'addGeneralReviewForm': 'generalReviews',
                'addPlaylistForm': 'playlists', 'addDiaryForm': 'diary', 'addGoalForm': 'goals',
                'addChallengeForm': 'challenges', 'addFavoriteForm': 'favorites', 'addTributeForm': 'tributes'
            };

            for (const [formId, dataType] of Object.entries(formMap)) {
                const form = document.getElementById(formId);
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const itemData = Object.fromEntries(formData.entries());
                        const itemId = parseFloat(itemData.id);

                        if (itemId) { // Editar
                            const itemIndex = data[dataType].findIndex(item => item.id === itemId);
                            if (itemIndex > -1) {
                                data[dataType][itemIndex] = { ...data[dataType][itemIndex], ...itemData, id: itemId };
                            }
                        } else { // Crear
                            itemData.id = generateUniqueId();
                            data[dataType].push(itemData);
                        }
                        
                        saveData();
                        renderCurrentSection();
                        closeModal(form.closest('.modal-backdrop').id);
                        showSuccess('¬°Guardado con √©xito!');
                    });
                }
            }
            
            const detailedReviewForm = document.getElementById('addDetailedBookReviewForm');
            if(detailedReviewForm) {
                detailedReviewForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(detailedReviewForm);
                    const reviewData = Object.fromEntries(formData.entries());
                    const bookId = parseFloat(reviewData.bookId);
                    const book = data.books.find(b => b.id === bookId);
                    if (book) {
                        book.review = reviewData;
                        saveData();
                        renderBookReviews();
                        renderFinished();
                        closeModal('addDetailedBookReviewModal');
                        showSuccess(`¬°Rese√±a de "${book.title}" guardada!`);
                    }
                });
            }
        }

        function openModal(modalId, itemId = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const form = modal.querySelector('form');
            if(form) form.reset();

            const titleElement = modal.querySelector('h3');
            const originalTitle = titleElement.textContent; // Guardamos el t√≠tulo original
            
            const formMap = {
                'addBookModal': 'books', 'addClubModal': 'clubs', 'addEventModal': 'events',
                'addQuoteModal': 'quotes', 'addWishModal': 'wishlist', 'addGeneralReviewModal': 'generalReviews',
                'addPlaylistModal': 'playlists', 'addDiaryModal': 'diary', 'addGoalModal': 'goals',
                'addChallengeModal': 'challenges', 'addFavoriteModal': 'favorites', 'addTributeModal': 'tributes'
            };

            if (itemId) {
                const dataType = formMap[modalId];
                if(dataType){
                    const item = data[dataType].find(i => i.id === itemId);
                    if (item) {
                        if(titleElement) titleElement.textContent = originalTitle.replace(/Agregar|Crear|Nuevo/g, 'Editar');
                        for (const key in item) {
                            if (form.elements[key]) {
                                form.elements[key].value = item[key];
                            }
                        }
                    }
                }
            } else {
                 if(titleElement) titleElement.textContent = originalTitle.replace('Editar', 'Crear'); // Resetea a t√≠tulo de creaci√≥n
            }
            
            if (modalId === 'addDetailedBookReviewModal' && itemId) {
                const book = data.books.find(b => b.id === itemId);
                if (book) {
                    document.getElementById('bookReviewBookId').value = book.id;
                    document.getElementById('bookReviewBookTitle').textContent = `Libro: ${book.title}`;
                    document.getElementById('bookReviewBookAuthor').textContent = `por ${book.author}`;
                    if (book.review) {
                        for (const key in book.review) {
                            if (form.elements[key]) form.elements[key].value = book.review[key];
                        }
                    }
                }
            }

            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
            // Solo quita la clase si no hay m√°s modales abiertos
            if (document.querySelectorAll('.modal-backdrop.active').length === 0) {
                 document.body.classList.remove('modal-open');
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-backdrop').forEach(modal => closeModal(modal.id));
        }

        function deleteItem(type, id) {
            if (confirm('¬øEst√°s segura de que quieres eliminar este elemento? Esta acci√≥n es irreversible.')) {
                data[type] = data[type].filter(item => item.id !== id);
                saveData();
                renderCurrentSection();
                showSuccess('Elemento eliminado.');
            }
        }
        
         function deleteDetailedReview(bookId) {
             const book = data.books.find(b => b.id === bookId);
              if (book && confirm(`¬øEliminar la rese√±a detallada de "${book.title}"?`)) {
                   book.review = null;
                  saveData();
                  renderBookReviews();
                  renderFinished();
                  showSuccess('Rese√±a eliminada.');
              }
         }
        
        function markFinished(bookId) {
            const book = data.books.find(b => b.id === bookId);
            if (book && confirm(`¬øMarcar "${book.title}" como terminado?`)) {
                book.isFinished = true;
                saveData();
                renderBooks();
                renderFinished();
                showGoalCelebration(`¬°Felicidades! Terminaste "${book.title}" üéâ`);
            }
        }

        // --- FUNCIONES DE INTERFAZ Y EFECTOS ---
        
        function showSuccess(message) {
            const existingMessage = document.querySelector('.success-message');
            if(existingMessage) existingMessage.remove();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        function showGoalCelebration(message) {
            showGoalMessage(message);
            showCelebration();
            const balloonColors = ['#f472b6', '#a78bfa', '#60a5fa', '#fde68a', '#fca5a5', '#98FB98'];
            for (let i = 0; i < 10; i++) {
                const balloon = document.createElement('div');
                balloon.className = 'balloon';
                balloon.style.left = Math.random() * 80 + 10 + '%';
                balloon.style.backgroundColor = balloonColors[Math.floor(Math.random() * balloonColors.length)];
                balloon.style.animationDelay = Math.random() * 1 + 's';
                balloon.style.animationDuration = (Math.random() * 3 + 5) + 's';
                document.body.appendChild(balloon);
                balloon.addEventListener('animationend', () => balloon.remove());
            }
        }
        
        function showGoalMessage(message) {
            document.querySelectorAll('.goal-message').forEach(msg => msg.remove());
            const goalMessageDiv = document.createElement('div');
            goalMessageDiv.className = 'goal-message';
            goalMessageDiv.innerHTML = message.replace(/\n/g, '<br>');
            document.body.appendChild(goalMessageDiv);
            setTimeout(() => {
                goalMessageDiv.remove();
            }, 3500);
        }

        function showCelebration() {
            if (document.querySelector('.celebration.active')) return;
            const celebration = document.createElement('div');
            celebration.className = 'celebration active';
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                celebration.appendChild(confetti);
            }
            document.body.appendChild(celebration);
            setTimeout(() => {
                celebration.remove();
            }, 4000);
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar(currentYear, currentMonth);
        }

        function showDayEvents(dateString) {
            const events = data.events.filter(event => event.date === dateString);
            if (events.length === 0) return;
            const formattedDate = new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            let details = `Eventos para el ${formattedDate}:\n\n` + events.map(e => `- ${e.title}${e.description ? `\n  (${e.description})` : ''}`).join('\n\n');
            alert(details);
        }

        function generateSuggestions() {
             showSuccess('Generando sugerencias...');
             const topBooks = [
                 { title: "El nombre del viento", author: "Patrick Rothfuss", genre: "Fantas√≠a √âpica", reason: "Ideal para amantes de la fantas√≠a con construcci√≥n de mundos complejos." },
                 { title: "Cien a√±os de soledad", author: "Gabriel Garc√≠a M√°rquez", genre: "Realismo M√°gico", reason: "Un cl√°sico imprescindible de la literatura latinoamericana." },
                 { title: "Los siete maridos de Evelyn Hugo", author: "Taylor Jenkins Reid", genre: "Ficci√≥n Hist√≥rica", reason: "Una historia adictiva sobre el glamour y los secretos del viejo Hollywood." },
                 { title: "Circe", author: "Madeline Miller", genre: "Fantas√≠a Mitol√≥gica", reason: "Una poderosa re-interpretaci√≥n de la mitolog√≠a griega desde una perspectiva femenina." },
                 { title: "Proyecto Hail Mary", author: "Andy Weir", genre: "Ciencia Ficci√≥n", reason: "Una aventura espacial llena de ciencia, humor y un misterio cautivador." }
             ];
             data.suggestions = topBooks.sort(() => 0.5 - Math.random()).slice(0, 5).map(book => ({ id: generateUniqueId(), ...book }));
             saveData();
             if (currentSection === 'suggestions') {
                 renderSuggestions();
             }
         }

        function toggleTributeContentField() { /* Placeholder */ }

        // --- DEPURACI√ìN ---
        window.merakelysiDebug = {
            getData: () => JSON.parse(JSON.stringify(data)),
            clearAll: () => {
                if (confirm('üö® ADVERTENCIA: ¬øBorrar TODOS los datos? Esta acci√≥n es irreversible.')) {
                    localStorage.removeItem('merakelysi_data');
                    localStorage.removeItem('merakelysi_userName');
                    location.reload();
                }
            }
        };
    </script>
