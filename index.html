<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merakelysi - Mi Universo Literario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- General & Base Styles --- */
        :root {
            --pink: #f472b6; --pink-light: #fbcfe8;
            --purple: #a855f7; --purple-light: #e9d5ff;
            --blue: #60a5fa; --blue-light: #bfdbfe;
            --green: #10b981; --green-light: #a7f3d0;
            --yellow: #f59e0b; --yellow-light: #fef08a;
            --red: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --bg-light: rgba(255, 255, 255, 0.9);
            --border-light: rgba(229, 231, 235, 0.7);
            --font-cursive: 'Caveat', cursive;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #fdf2f8, #f5f3ff, #ecfdf5);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><text y='20' font-size='20'>🦄</text></svg>"), auto;
        }
        body.modal-open { overflow: hidden; }

        /* --- UI Components (Cards, Buttons, etc.) --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }

        .card {
            background: var(--bg-light); border-radius: 24px; padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-light); cursor: pointer; transition: all 0.3s ease;
            backdrop-filter: blur(10px); text-align: center;
        }
        .card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .card-icon { font-size: 2rem; margin-bottom: 0.75rem; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
        .card-title { font-size: 1.05rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }

        .btn {
            background: linear-gradient(135deg, var(--pink), #e879f9); color: white; border: none; padding: 0.8rem 1.6rem;
            border-radius: 12px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(244, 114, 182, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(244, 114, 182, 0.3); }
        .btn.back-btn { background: linear-gradient(135deg, #cbd5e1, #94a3b8); }

        /* --- Header --- */
        .header { text-align: center; margin-bottom: 3rem; padding: 2.5rem 2rem; background: rgba(255, 255, 255, 0.6); border-radius: 24px; box-shadow: 0 16px 32px rgba(0, 0, 0, 0.08); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.8); }
        .title { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 10vw, 5rem); background: linear-gradient(to right, var(--pink), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .author-attribution { font-size: 1rem; color: var(--purple); font-weight: 600; margin-bottom: 1.5rem; }
        .user-name-input input { border: none; border-bottom: 2px dashed var(--pink); background: none; font-size: 1.2rem; color: var(--text-primary); font-weight: 600; text-align: center; width: 220px; padding: 0.2rem 0.5rem; }
        .user-name-input input:focus { outline: none; border-bottom-color: var(--purple); }
        .status { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem;}
        .status-dot { width: 8px; height: 8px; background-color: var(--green); border-radius: 50%; animation: pulse-status 2s infinite; }
        
        /* --- Sections and Item Cards --- */
        .nav-section { display: none; }
        .nav-section.active { display: block; animation: fadeIn 0.5s ease; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .items-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        
        .item-card {
            background: var(--bg-light); border-radius: 16px; padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border: 1px solid var(--border-light);
            position: relative; transition: all 0.3s ease; backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .item-card.has-image { flex-direction: row; gap: 1.5rem; align-items: flex-start; }
        .item-card-image { width: 100px; height: 150px; object-fit: cover; border-radius: 8px; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .item-content { flex-grow: 1; word-wrap: break-word; }
        .item-title { font-size: 1.25rem; }
        .item-subtitle { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .item-meta { color: var(--purple); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .item-notes { font-size: 0.9rem; color: var(--text-secondary); white-space: pre-wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-light); }
        .item-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
        .action-btn { background: #a78bfa; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer;}
        .action-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .action-btn.action-edit { background-color: var(--blue); }
        .action-btn.action-finish { background-color: var(--green); }
        .action-btn.action-review { background-color: var(--yellow); }
        .delete-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: #fca5a5; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; opacity: 0.5; }
        .item-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: var(--red); transform: scale(1.1) rotate(90deg); }

        /* --- Modal Styles --- */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(245, 243, 255, 0.5); backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(135deg, #ffffff, #f5f3ff); padding: 2.5rem; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid white; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .modal-content h3 { font-family: 'Playfair Display', serif; color: var(--text-primary); margin-bottom: 2rem; text-align: center; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #9ca3af; transition: color 0.2s ease, transform 0.2s ease; line-height: 1; }
        .modal-close-btn:hover { color: var(--red); transform: rotate(90deg); }
        .form-group { margin-bottom: 1rem; }
        .form-row { display: flex; gap: 1rem; } .form-row > .form-group { flex: 1; }
        .modal-form label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary); }
        .modal-form input, .modal-form textarea, .modal-form select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; background-color: #f9fafb; }
        .modal-form input[type="file"] { padding: 0.5rem; }
        .image-preview { width: 100px; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 0.5rem; border: 1px solid #d1d5db; display: none; }
        
        /* --- Book Review Display --- */
        .book-review-display {
            background: url('https://www.transparenttextures.com/patterns/paper-fibers.png'), #fffaf4;
            padding: 3rem; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 10px solid var(--green-light); position: relative;
        }
        .book-review-display::before { content: '🦋'; position: absolute; top: 20px; right: 20px; font-size: 2rem; opacity: 0.5;}
        .review-header { text-align: center; margin-bottom: 2rem; }
        .review-header h2 { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--green); }
        .review-grid { display: grid; grid-template-columns: 1fr 200px; gap: 2rem; align-items: start; }
        .review-main-content { grid-column: 1 / 2; }
        .review-sidebar { grid-column: 2 / 3; }
        .review-cover { width: 100%; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); margin-bottom: 1.5rem; border: 5px solid white; }
        .review-meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .review-meta-item { background: var(--pink-light); padding: 1rem; border-radius: 12px; }
        .review-meta-item h4 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .review-meta-item p { font-weight: 600; font-size: 1.1rem; }
        .review-section { margin-bottom: 2rem; }
        .review-section h3 { font-family: var(--font-cursive); font-size: 2rem; color: var(--purple); border-bottom: 2px dashed var(--purple-light); display: inline-block; margin-bottom: 1rem; }
        .review-section p, .review-section ul { background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 12px; line-height: 1.7; }
        .review-section ul { list-style-position: inside; }
        .rating-display { font-size: 2rem; }
        .rating-display .filled { color: var(--yellow); }
        .rating-display .empty { color: #d1d5db; }

        /* --- Notification & Celebration --- */
        #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .notification { padding: 1rem 1.5rem; border-radius: 12px; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); font-weight: 600; animation: slide-in 0.5s forwards, slide-out 0.5s 3s forwards; }
        .notification.success { background: linear-gradient(135deg, var(--green), #34d399); }
        .notification.error { background: linear-gradient(135deg, var(--red), #f87171); }
        @keyframes slide-in { from { transform: translateX(calc(100% + 20px)); } to { transform: translateX(0); } }
        @keyframes slide-out { from { transform: translateX(0); } to { transform: translateX(calc(100% + 20px)); } }
        #celebration-container { position: fixed; inset: 0; z-index: 3000; pointer-events: none; overflow: hidden; }
        .celebration-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 2rem 3rem; background: var(--bg-light); border-radius: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); text-align: center; animation: celebrate-fade 4s ease-out; backdrop-filter: blur(10px); }
        .celebration-message span { font-size: 4rem; display: block; }
        .celebration-message p { font-size: 1.5rem; font-weight: 600; color: var(--purple); margin-top: 1rem; }
        .confetti, .balloon { position: absolute; top: -50px; animation-duration: 4s; animation-iteration-count: infinite; animation-timing-function: linear; }
        .confetti { width: 10px; height: 10px; }
        .balloon { font-size: 2rem; opacity: 0.7; }
        @keyframes fall { to { transform: translateY(105vh) rotate(720deg); opacity: 0; } }
        @keyframes celebrate-fade { 0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } 20%, 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @keyframes pulse-status { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Secciones dinámicas -->
        <section id="home" class="nav-section"></section>
        <section id="books" class="nav-section"></section>
        <section id="clubs" class="nav-section"></section>
        <section id="playlists" class="nav-section"></section>
        <section id="tributes" class="nav-section"></section>
        <section id="finished" class="nav-section"></section>
        <section id="bookReviews" class="nav-section"></section>
        <!-- Agrega más secciones aquí si es necesario -->
    </div>

    <!-- Contenedores globales -->
    <div id="modal-container"></div>
    <div id="notification-container"></div>
    <div id="celebration-container"></div>
    
    <!-- Plantillas HTML para Modales -->
    <template id="modal-template-book">
        <div class="modal-backdrop" id="bookModal">
            <div class="modal-content">
                <button class="modal-close-btn">×</button>
                <h3>Nuevo Libro</h3>
                <form class="modal-form" data-section="books">
                    <input type="hidden" name="id">
                    <div class="form-group">
                        <label for="bookCoverImage">Portada del Libro</label>
                        <input type="file" id="bookCoverImage" name="coverImageFile" accept="image/*">
                        <img class="image-preview" id="coverPreview" src="#" alt="Vista previa de la portada">
                    </div>
                    <div class="form-group"><label for="bookTitle">Título</label><input type="text" id="bookTitle" name="title" required></div>
                    <div class="form-group"><label for="bookAuthor">Autor(a)</label><input type="text" id="bookAuthor" name="author" required></div>
                    <div class="form-row">
                        <div class="form-group"><label for="bookPages">Nº Páginas</label><input type="number" id="bookPages" name="pages"></div>
                        <div class="form-group"><label for="bookChapters">Nº Capítulos</label><input type="number" id="bookChapters" name="chapters"></div>
                    </div>
                    <div class="form-group"><label for="bookClub">Club de Lectura (Opcional)</label><select id="bookClub" name="clubId"></select></div>
                    <div class="form-group"><label for="bookWeeklyGoal">Meta Semanal (págs/caps)</label><input type="text" id="bookWeeklyGoal" name="weeklyGoal"></div>
                    <button type="submit" class="btn">Guardar Libro</button>
                </form>
            </div>
        </div>
    </template>

    <template id="modal-template-club">
        <div class="modal-backdrop" id="clubModal">
            <div class="modal-content">
                <button class="modal-close-btn">×</button>
                <h3>Nuevo Club de Lectura</h3>
                <form class="modal-form" data-section="clubs">
                    <input type="hidden" name="id">
                    <div class="form-group"><label for="clubName">Nombre del Club</label><input type="text" id="clubName" name="name" required></div>
                    <div class="form-group"><label for="clubMeetingDays">Días de Reunión</label><input type="text" id="clubMeetingDays" name="meetingDays" placeholder="Ej: Lunes y Jueves"></div>
                    <div class="form-row">
                        <div class="form-group"><label for="clubWeeklyGoal">Meta Semanal (libros)</label><input type="number" id="clubWeeklyGoal" name="weeklyGoal"></div>
                        <div class="form-group"><label for="clubMonthlyGoal">Meta Mensual (libros)</label><input type="number" id="clubMonthlyGoal" name="monthlyGoal"></div>
                    </div>
                    <div class="form-group"><label for="clubMemberCount">Nº Integrantes</label><input type="number" id="clubMemberCount" name="memberCount"></div>
                    <div class="form-group"><label for="clubAuthorMeeting">Fecha Reunión con Autor</label><input type="date" id="clubAuthorMeeting" name="authorMeetingDate"></div>
                    <button type="submit" class="btn">Guardar Club</button>
                </form>
            </div>
        </div>
    </template>

    <template id="modal-template-review">
        <div class="modal-backdrop" id="reviewModal">
            <div class="modal-content">
                <button class="modal-close-btn">×</button>
                <h3>Mi Reseña de Libro</h3>
                <form class="modal-form" data-section="reviews">
                    <input type="hidden" name="id">
                    <input type="hidden" name="bookId">
                    <div class="form-group">
                        <label>Calificación</label>
                        <div class="rating-input">
                            <input type="radio" id="star5" name="rating" value="5" /><label for="star5">★</label>
                            <input type="radio" id="star4" name="rating" value="4" /><label for="star4">★</label>
                            <input type="radio" id="star3" name="rating" value="3" /><label for="star3">★</label>
                            <input type="radio" id="star2" name="rating" value="2" /><label for="star2">★</label>
                            <input type="radio" id="star1" name="rating" value="1" /><label for="star1">★</label>
                        </div>
                    </div>
                    <div class="form-group"><label for="reviewGenre">Género</label><input type="text" id="reviewGenre" name="genre"></div>
                    <div class="form-group"><label for="reviewFavChars">Personajes Favoritos</label><textarea id="reviewFavChars" name="favoriteCharacters"></textarea></div>
                    <div class="form-group"><label for="reviewLikedMost">Lo que más me gustó</label><textarea id="reviewLikedMost" name="likedMost"></textarea></div>
                    <div class="form-group"><label for="reviewLearnings">Aprendizajes</label><textarea id="reviewLearnings" name="learnings"></textarea></div>
                    <div class="form-group"><label for="reviewQuotes">Frases</label><textarea id="reviewQuotes" name="quotes"></textarea></div>
                    <div class="form-group"><label for="reviewChangeFinal">¿Cambiarías el final?</label><input type="text" id="reviewChangeFinal" name="changeFinal"></div>
                    <div class="form-group"><label for="reviewRecommend">¿Lo recomendarías?</label><input type="text" id="reviewRecommend" name="recommend"></div>
                    <button type="submit" class="btn">Guardar Reseña</button>
                </form>
            </div>
        </div>
        <style> /* Estilos específicos para el input de estrellas */
            .rating-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
            .rating-input input { display: none; }
            .rating-input label { font-size: 2rem; color: #ccc; cursor: pointer; transition: color 0.2s; }
            .rating-input label:hover, .rating-input label:hover ~ label,
            .rating-input input:checked ~ label { color: var(--yellow); }
        </style>
    </template>
    
    <!-- Agrega aquí las plantillas para playlist y tributes si son necesarias -->

<script>
// ===================================================================================
// MERAKELYSI APP 4.0 - ESTÉTICA Y FUNCIONALIDAD AMPLIADA
// Arquitecto de Código: Tu Asistente IA de Confianza
// ===================================================================================
document.addEventListener('DOMContentLoaded', () => {

    const config = {
        storageKey: 'merakelysi_data_v4',
        userNameKey: 'merakelysi_userName_v4',
        sections: [
            { id: 'books', title: 'Mis Libros por Leer', icon: '📚', modal: 'bookModal', formTemplate: 'modal-template-book' },
            { id: 'finished', title: 'Lecturas Terminadas', icon: '✅' },
            { id: 'clubs', title: 'Mis Clubes de Lectura', icon: '👥', modal: 'clubModal', formTemplate: 'modal-template-club' },
            { id: 'bookReviews', title: 'Mis Reseñas', icon: '🖋️' },
            { id: 'playlists', title: 'Playlists Literarias', icon: '🎧', dev: true },
            { id: 'tributes', title: 'Homenajes Literarios', icon: '✨', dev: true },
        ],
        pastelColors: ['#fbcfe8', '#e9d5ff', '#bfdbfe', '#a7f3d0', '#fef08a', '#fed7aa'],
        balloons: ['🎈', '🎉', '🎊', '🎁', '🎀']
    };

    const state = {
        currentSection: 'home',
        userName: '',
        db: {},
        tempCoverImage: null
    };

    const utils = {
        generateId: () => Date.now() + Math.random().toString(36).substr(2, 9),
        sanitizeHTML: (str) => {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        },
        formatDate: (dateString) => dateString ? new Date(dateString).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'
    };
    
    const storage = {
        save() { try { localStorage.setItem(config.storageKey, JSON.stringify(state.db)); } catch (e) { console.error('Error al guardar', e); } },
        load() {
            const emptyDB = { books: [], clubs: [], reviews: [], playlists: [], tributes: [] };
            try {
                const savedData = localStorage.getItem(config.storageKey);
                state.db = { ...emptyDB, ...(savedData ? JSON.parse(savedData) : {}) };
            } catch (e) { state.db = emptyDB; console.error('Error al cargar', e); }
        },
        loadUserName() { state.userName = localStorage.getItem(config.userNameKey) || ''; },
        saveUserName(name) { state.userName = name; localStorage.setItem(config.userNameKey, name); }
    };

    const ui = {
        elements: {
            container: document.querySelector('.container'),
            modalContainer: document.getElementById('modal-container'),
            notificationContainer: document.getElementById('notification-container'),
            celebrationContainer: document.getElementById('celebration-container'),
        },
        renderSection(sectionId, detailId = null) {
            document.querySelectorAll('.nav-section').forEach(s => s.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                state.currentSection = sectionId;
                this.renderContentForCurrentSection(detailId);
                window.scrollTo(0, 0);
            }
        },
        renderContentForCurrentSection(detailId = null) {
            const sectionId = state.currentSection;
            const sectionEl = document.getElementById(sectionId);
            if (!sectionEl) return;

            if (sectionId === 'home') { this._renderHomePage(); return; }

            const sectionConfig = config.sections.find(s => s.id === sectionId);
            if (!sectionConfig) return;

            sectionEl.innerHTML = this._createSectionHeader(sectionConfig);
            const contentContainer = document.createElement('div');
            contentContainer.id = `${sectionId}Container`;
            sectionEl.appendChild(contentContainer);
            
            const renderFn = rendering[sectionId] || rendering.default;
            renderFn(contentContainer, sectionConfig, detailId);
        },
        _renderHomePage() {
            const homeSection = document.getElementById('home');
            homeSection.innerHTML = `
                <header class="header">
                    <h1 class="title">Merakelysi</h1>
                    <p class="author-attribution">By Maribel Alba</p>
                    <div class="user-name-input"><label>Hola, </label><input type="text" id="userName" placeholder="tu nombre" value="${utils.sanitizeHTML(state.userName)}"></div>
                    <div class="status"><div class="status-dot"></div><span>Datos guardados automáticamente</span></div>
                </header>
                <main id="homeGrid" class="grid">
                    ${config.sections.map(s => `
                        <div class="card" data-action="navigate" data-section-id="${s.id}">
                            <div class="card-icon">${s.icon}</div>
                            <h3 class="card-title">${s.title}${s.dev ? ' (Próximamente)' : ''}</h3>
                        </div>`).join('')}
                </main>`;
        },
        _createSectionHeader(sectionConfig) {
            let buttonHtml = '';
            if (sectionConfig.modal && sectionConfig.id !== 'bookReviews') {
                 buttonHtml = `<button class="btn" data-action="open-modal" data-modal-id="${sectionConfig.modal}">+ Nuevo</button>`;
            }
            return `<div class="section-header">
                        <button class="btn back-btn" data-action="navigate" data-section-id="home">← Inicio</button>
                        <h2 class="section-title">${sectionConfig.title}</h2>
                        ${buttonHtml}
                    </div>`;
        },
        showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            this.elements.notificationContainer.appendChild(notif);
            setTimeout(() => notif.remove(), 3500);
        },
        showCelebration(message) {
            this.elements.celebrationContainer.innerHTML = '';
            const celebration = document.createElement('div');
            celebration.className = 'celebration-message';
            celebration.innerHTML = `<span>🎉</span><p>${utils.sanitizeHTML(message)}</p>`;
            this.elements.celebrationContainer.appendChild(celebration);
            
            for (let i = 0; i < 70; i++) {
                const isBalloon = Math.random() > 0.9;
                const el = document.createElement('div');
                el.className = isBalloon ? 'balloon' : 'confetti';
                el.style.left = `${Math.random() * 100}vw`;
                el.style.animationName = 'fall';
                el.style.animationDelay = `${Math.random() * 4}s`;
                if(isBalloon){
                    el.textContent = config.balloons[Math.floor(Math.random() * config.balloons.length)];
                    el.style.animationDuration = `${Math.random() * 3 + 4}s`;
                } else {
                    el.style.backgroundColor = config.pastelColors[Math.floor(Math.random() * config.pastelColors.length)];
                    el.style.animationDuration = `${Math.random() * 2 + 3}s`;
                }
                this.elements.celebrationContainer.appendChild(el);
                setTimeout(() => el.remove(), 7000);
            }
            setTimeout(() => celebration.remove(), 4000);
        }
    };

    const modals = {
        open(modalId, itemId = null) {
            const sectionConfig = config.sections.find(s => s.modal === modalId);
            if (!sectionConfig || !document.getElementById(sectionConfig.formTemplate)) return;

            const template = document.getElementById(sectionConfig.formTemplate);
            const clone = template.content.cloneNode(true);
            const modalEl = clone.querySelector('.modal-backdrop');
            const form = modalEl.querySelector('form');
            const titleEl = modalEl.querySelector('h3');
            
            state.tempCoverImage = null; // Reset temp image

            if (modalId === 'bookModal') {
                const clubSelect = modalEl.querySelector('#bookClub');
                clubSelect.innerHTML = '<option value="">Ninguno</option>' + state.db.clubs.map(c => `<option value="${c.id}">${utils.sanitizeHTML(c.name)}</option>`).join('');
            }

            if (itemId) { // Modo Edición
                const itemData = state.db[form.dataset.section].find(item => item.id == itemId);
                if (itemData) {
                    titleEl.textContent = titleEl.textContent.replace('Nuevo', 'Editar');
                    for (const key in itemData) {
                        if (form.elements[key]) form.elements[key].value = itemData[key];
                    }
                    if(itemData.coverImage) {
                         const preview = modalEl.querySelector('.image-preview');
                         preview.src = itemData.coverImage;
                         preview.style.display = 'block';
                    }
                }
            } else if (modalId === 'reviewModal') { // Abrir reseña para un libro específico
                const book = state.db.books.find(b => b.id == itemId);
                if(book) {
                    form.bookId.value = book.id;
                    const review = state.db.reviews.find(r => r.bookId == book.id);
                    if(review) { // Editando reseña existente
                        titleEl.textContent = `Editando reseña de "${book.title}"`;
                        for (const key in review) {
                            if (form.elements[key]) {
                                if(form.elements[key].type === 'radio') {
                                    form.querySelector(`[name=${key}][value="${review[key]}"]`).checked = true;
                                } else {
                                    form.elements[key].value = review[key];
                                }
                            }
                        }
                    } else { // Nueva reseña
                        titleEl.textContent = `Reseña para "${book.title}"`;
                    }
                }
            }
            
            ui.elements.modalContainer.innerHTML = '';
            ui.elements.modalContainer.appendChild(clone);
            requestAnimationFrame(() => ui.elements.modalContainer.querySelector('.modal-backdrop').classList.add('active'));
            document.body.classList.add('modal-open');
        },
        close() {
            const modalEl = ui.elements.modalContainer.querySelector('.modal-backdrop');
            if(modalEl) {
                modalEl.classList.remove('active');
                modalEl.addEventListener('transitionend', () => {
                    ui.elements.modalContainer.innerHTML = '';
                    document.body.classList.remove('modal-open');
                }, { once: true });
            }
        }
    };

    const rendering = {
        _createItemCard({ id, section, title, subtitle, meta, notes, imageSrc, buttons = [] }) {
            const buttonsHtml = buttons.map(btn => `<button class="action-btn ${btn.class}" data-action="${btn.action}" data-id="${id}">${btn.label}</button>`).join('');
            const imageHtml = imageSrc ? `<img src="${imageSrc}" alt="Portada de ${utils.sanitizeHTML(title)}" class="item-card-image">` : '';
            return `
                <div class="item-card ${imageSrc ? 'has-image' : ''}" data-id="${id}">
                    ${imageHtml}
                    <div class="item-content">
                        <button class="delete-btn" data-action="delete-item" data-section="${section}" data-id="${id}">×</button>
                        <h3 class="item-title">${utils.sanitizeHTML(title)}</h3>
                        ${subtitle ? `<p class="item-subtitle">${utils.sanitizeHTML(subtitle)}</p>` : ''}
                        ${meta ? `<p class="item-meta">${utils.sanitizeHTML(meta)}</p>` : ''}
                        ${notes ? `<p class="item-notes">${utils.sanitizeHTML(notes)}</p>` : ''}
                        <div class="item-actions">${buttonsHtml}</div>
                    </div>
                </div>`;
        },
        _renderEmptyState(container, icon, message, submessage) {
            container.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><div class="card-icon">${icon}</div><h3>${message}</h3><p>${submessage}</p></div>`;
        },
        default(container, sectionConfig) { this._renderEmptyState(container, '🚧', `Sección "${sectionConfig.title}" en Construcción`, '¡Vuelve pronto para más magia literaria!'); },

        books(container) {
            const items = state.db.books.filter(b => !b.isFinished);
            if (items.length === 0) { this._renderEmptyState(container, '📚', 'No hay libros por leer', '¡Agrega un nuevo libro para empezar!'); return; }
            container.className = 'items-grid';
            container.innerHTML = items.map(book => {
                const club = state.db.clubs.find(c => c.id == book.clubId);
                return this._createItemCard({
                    id: book.id, section: 'books', title: book.title, subtitle: `por ${book.author}`,
                    meta: club ? `Club: ${club.name}` : '', imageSrc: book.coverImage,
                    notes: `Meta: ${book.weeklyGoal || 'N/A'}`,
                    buttons: [
                        { class: 'action-edit', label: 'Editar', action: 'edit-item' },
                        { class: 'action-finish', label: '✅ Terminar', action: 'finish-book' }
                    ]
                });
            }).join('');
        },
        
        finished(container) {
            const items = state.db.books.filter(b => b.isFinished);
            if (items.length === 0) { this._renderEmptyState(container, '✅', 'Aún no has terminado ningún libro', '¡Sigue leyendo!'); return; }
            container.className = 'items-grid';
            container.innerHTML = items.map(book => {
                const hasReview = state.db.reviews.some(r => r.bookId == book.id);
                return this._createItemCard({
                    id: book.id, section: 'books', title: book.title, subtitle: `por ${book.author}`,
                    meta: '¡Lectura completada!', imageSrc: book.coverImage,
                    buttons: [{
                        class: hasReview ? 'action-edit' : 'action-review',
                        label: hasReview ? 'Ver/Editar Reseña' : '✍️ Escribir Reseña',
                        action: 'write-review'
                    }]
                });
            }).join('');
        },

        clubs(container) {
            const items = state.db.clubs;
            if (items.length === 0) { this._renderEmptyState(container, '👥', 'No tienes clubes de lectura', '¡Crea uno para compartir tus lecturas!'); return; }
            container.className = 'items-grid';
            container.innerHTML = items.map(club => this._createItemCard({
                id: club.id, section: 'clubs', title: club.name, subtitle: `${club.memberCount || 0} integrantes`,
                meta: `Reuniones: ${club.meetingDays || 'N/A'}`,
                notes: `Reunión con autor: ${utils.formatDate(club.authorMeetingDate)}`,
                buttons: [{ class: 'action-edit', label: 'Editar', action: 'edit-item' }]
            })).join('');
        },

        bookReviews(container, _, detailId) {
            if (detailId) {
                this._renderSingleReview(container, detailId);
                return;
            }
            container.innerHTML = `<div class="empty-state"><p>Selecciona un libro de la sección "Lecturas Terminadas" para ver o escribir su reseña.</p></div>`;
        },
        _renderSingleReview(container, bookId) {
            const book = state.db.books.find(b => b.id == bookId);
            const review = state.db.reviews.find(r => r.bookId == bookId);
            if(!book || !review) { this._renderEmptyState(container, '❓', 'Reseña no encontrada', 'Parece que algo salió mal.'); return; }
            
            const ratingHtml = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
            container.className = ''; // Remove grid
            container.innerHTML = `
                <div class="book-review-display">
                    <div class="review-header"><h2>Reseña de Libro</h2></div>
                    <div class="review-grid">
                        <div class="review-main-content">
                            <div class="review-meta-grid">
                                <div class="review-meta-item"><h4>Título</h4><p>${utils.sanitizeHTML(book.title)}</p></div>
                                <div class="review-meta-item"><h4>Autor(a)</h4><p>${utils.sanitizeHTML(book.author)}</p></div>
                                <div class="review-meta-item"><h4>Género</h4><p>${utils.sanitizeHTML(review.genre)}</p></div>
                                <div class="review-meta-item"><h4>Páginas</h4><p>${book.pages || 'N/A'}</p></div>
                            </div>
                            <div class="review-section"><h3>Lo que más me gustó:</h3><p>${utils.sanitizeHTML(review.likedMost)}</p></div>
                            <div class="review-section"><h3>Personajes Favoritos:</h3><p>${utils.sanitizeHTML(review.favoriteCharacters)}</p></div>
                            <div class="review-section"><h3>Frases:</h3><p>${utils.sanitizeHTML(review.quotes)}</p></div>
                            <div class="review-section"><h3>Aprendizajes:</h3><p>${utils.sanitizeHTML(review.learnings)}</p></div>
                        </div>
                        <div class="review-sidebar">
                            <img src="${book.coverImage || 'https://via.placeholder.com/200x300.png?text=Sin+Portada'}" alt="Portada" class="review-cover">
                            <div class="review-section"><h3>Calificación</h3><div class="rating-display">${ratingHtml.replace(/★/g, '<span class="filled">★</span>').replace(/☆/g, '<span class="empty">☆</span>')}</div></div>
                            <div class="review-section"><h3>¿Cambiarías el final?</h3><p>${utils.sanitizeHTML(review.changeFinal)}</p></div>
                            <div class="review-section"><h3>¿Lo recomendarías?</h3><p>${utils.sanitizeHTML(review.recommend)}</p></div>
                        </div>
                    </div>
                </div>`;
        }
    };

    const app = {
        init() {
            storage.load();
            storage.loadUserName();
            ui.renderSection('home');
            this.addEventListeners();
            console.log("🦄 Merakelysi App 4.0 inicializada.");
        },
        addEventListeners() {
            document.body.addEventListener('click', (e) => {
                const action = e.target.dataset.action; if (!action) return;
                const id = e.target.dataset.id;
                const handler = this.actions[action];
                if (handler) handler.call(this, e.target, id);
            });
            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'userName') storage.saveUserName(e.target.value);
                if (e.target.type === 'file' && e.target.accept.startsWith('image')) this.handleImagePreview(e.target);
            });
            ui.elements.modalContainer.addEventListener('submit', (e) => { e.preventDefault(); if (e.target.tagName === 'FORM') this.handleFormSubmit(e.target); });
            ui.elements.modalContainer.addEventListener('click', (e) => { if (e.target.classList.contains('modal-backdrop') || e.target.classList.contains('modal-close-btn')) modals.close(); });
            window.addEventListener('beforeunload', storage.save);
        },

        actions: {
            navigate(target) { ui.renderSection(target.dataset.sectionId); },
            'open-modal'(target) { modals.open(target.dataset.modalId); },
            'edit-item'(target, id) {
                const modalId = config.sections.find(s => s.id === state.currentSection)?.modal;
                if(modalId) modals.open(modalId, id);
            },
            'delete-item'(target, id) {
                if (confirm('¿Estás segura de que quieres eliminar esto?')) {
                    const sectionKey = target.dataset.section;
                    state.db[sectionKey] = state.db[sectionKey].filter(item => item.id != id);
                    ui.renderContentForCurrentSection();
                    ui.showNotification('Elemento eliminado.', 'success');
                }
            },
            'finish-book'(target, id) {
                const book = state.db.books.find(b => b.id == id);
                if (book && confirm(`¿Marcar "${book.title}" como terminado?`)) {
                    book.isFinished = true;
                    ui.renderContentForCurrentSection();
                    ui.showCelebration(`¡Felicidades, has logrado la meta de leer "${book.title}"!`);
                }
            },
            'write-review'(target, bookId) {
                const review = state.db.reviews.find(r => r.bookId == bookId);
                if (review) {
                    ui.renderSection('bookReviews', bookId);
                } else {
                    modals.open('reviewModal', bookId);
                }
            }
        },
        
        handleImagePreview(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                state.tempCoverImage = e.target.result;
                const previewEl = fileInput.closest('.modal-form').querySelector('.image-preview');
                if(previewEl) {
                    previewEl.src = e.target.result;
                    previewEl.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        },
        handleFormSubmit(form) {
            const sectionKey = form.dataset.section;
            if (!state.db[sectionKey]) return;
            
            const formData = new FormData(form);
            const itemData = Object.fromEntries(formData.entries());
            const itemId = itemData.id;
            
            if (sectionKey === 'books' && state.tempCoverImage) {
                itemData.coverImage = state.tempCoverImage;
            }
            delete itemData.id; delete itemData.coverImageFile;

            if (itemId) { // Editar
                const index = state.db[sectionKey].findIndex(item => item.id == itemId);
                if (index > -1) {
                    const existingItem = state.db[sectionKey][index];
                    // No sobreescribir la imagen si no se subió una nueva
                    if (sectionKey === 'books' && !state.tempCoverImage) {
                        itemData.coverImage = existingItem.coverImage;
                    }
                    state.db[sectionKey][index] = { ...existingItem, ...itemData };
                    ui.showNotification('¡Actualizado con éxito!', 'success');
                }
            } else { // Agregar
                itemData.id = utils.generateId();
                if (sectionKey === 'books') itemData.isFinished = false;
                if (sectionKey === 'reviews') { // Si es una reseña, la creamos y vinculamos
                    const existingReviewIndex = state.db.reviews.findIndex(r => r.bookId == itemData.bookId);
                    if (existingReviewIndex > -1) state.db.reviews.splice(existingReviewIndex, 1); // Borramos la vieja si existe
                }
                state.db[sectionKey].push(itemData);
                ui.showNotification('¡Guardado con éxito!', 'success');
            }
            
            modals.close();
            // Si acabamos de guardar una reseña, vamos a verla
            if (sectionKey === 'reviews') {
                ui.renderSection('bookReviews', itemData.bookId);
            } else {
                ui.renderContentForCurrentSection();
            }
        },
    };

    app.init();
});
</script>
</body>
</html>
