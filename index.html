<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merakelysi - Mi Universo Literario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- General & Base Styles --- */
        :root {
            --pink: #f472b6; --pink-light: #fbcfe8;
            --purple: #a855f7; --purple-light: #e9d5ff;
            --blue: #60a5fa; --blue-light: #bfdbfe;
            --green: #10b981; --green-light: #a7f3d0;
            --yellow: #f59e0b; --yellow-light: #fef08a;
            --red: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --bg-light: rgba(255, 255, 255, 0.9);
            --border-light: rgba(229, 231, 235, 0.7);
            --font-cursive: 'Caveat', cursive;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #fdf2f8, #f5f3ff, #ecfdf5);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><text y='20' font-size='20'>ü¶Ñ</text></svg>"), auto;
        }
        body.modal-open { overflow: hidden; }

        /* --- UI Components (Cards, Buttons, etc.) --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }

        .card {
            background: var(--bg-light); border-radius: 24px; padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-light); cursor: pointer; transition: all 0.3s ease;
            backdrop-filter: blur(10px); text-align: center;
        }
        .card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .card-icon { font-size: 2rem; margin-bottom: 0.75rem; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
        .card-title { font-size: 1.05rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }

        .btn {
            background: linear-gradient(135deg, var(--pink), #e879f9); color: white; border: none; padding: 0.8rem 1.6rem;
            border-radius: 12px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(244, 114, 182, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(244, 114, 182, 0.3); }
        .btn.back-btn { background: linear-gradient(135deg, #cbd5e1, #94a3b8); }

        /* --- Header --- */
        .header { text-align: center; margin-bottom: 3rem; padding: 2.5rem 2rem; background: rgba(255, 255, 255, 0.6); border-radius: 24px; box-shadow: 0 16px 32px rgba(0, 0, 0, 0.08); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.8); }
        .title { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 10vw, 5rem); background: linear-gradient(to right, var(--pink), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .author-attribution { font-size: 1rem; color: var(--purple); font-weight: 600; margin-bottom: 1.5rem; }
        .user-name-input input { border: none; border-bottom: 2px dashed var(--pink); background: none; font-size: 1.2rem; color: var(--text-primary); font-weight: 600; text-align: center; width: 220px; padding: 0.2rem 0.5rem; }
        .user-name-input input:focus { outline: none; border-bottom-color: var(--purple); }
        .status { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem;}
        .status-dot { width: 8px; height: 8px; background-color: var(--green); border-radius: 50%; animation: pulse-status 2s infinite; }
        
        /* --- Sections and Item Cards --- */
        .nav-section { display: none; }
        .nav-section.active { display: block; animation: fadeIn 0.5s ease; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .items-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        
        .item-card {
            background: var(--bg-light); border-radius: 16px; padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border: 1px solid var(--border-light);
            position: relative; transition: all 0.3s ease; backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .item-card.has-image { flex-direction: row; gap: 1.5rem; align-items: flex-start; }
        .item-card-image { width: 100px; height: 150px; object-fit: cover; border-radius: 8px; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .item-content { flex-grow: 1; word-wrap: break-word; text-align: left; }
        .item-title { font-size: 1.25rem; margin-bottom: 0.25rem; font-weight: 700; }
        .item-subtitle { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .item-meta { color: var(--purple); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .item-notes { font-size: 0.9rem; color: var(--text-secondary); white-space: pre-wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-light); }
        .item-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
        .action-btn { background: #a78bfa; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer;}
        .action-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .action-btn.action-edit { background-color: var(--blue); }
        .action-btn.action-finish { background-color: var(--green); }
        .action-btn.action-review { background-color: var(--yellow); }
        .delete-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: #fca5a5; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; opacity: 0.5; cursor: pointer;}
        .item-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: var(--red); transform: scale(1.1) rotate(90deg); }

        /* --- Modal Styles --- */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(245, 243, 255, 0.5); backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(135deg, #ffffff, #f5f3ff); padding: 2.5rem; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid white; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .modal-content h3 { font-family: 'Playfair Display', serif; color: var(--text-primary); margin-bottom: 2rem; text-align: center; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #9ca3af; transition: color 0.2s ease, transform 0.2s ease; line-height: 1; }
        .modal-close-btn:hover { color: var(--red); transform: rotate(90deg); }
        .form-group { margin-bottom: 1rem; }
        .form-row { display: flex; gap: 1rem; } .form-row > .form-group { flex: 1; }
        .modal-form label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary); }
        .modal-form input, .modal-form textarea, .modal-form select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; background-color: #f9fafb; }
        .modal-form input:focus, .modal-form textarea:focus, .modal-form select:focus { outline: none; border-color: var(--pink); box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2); }
        .modal-form input[type="file"] { padding: 0.5rem; }
        .image-preview { width: 100px; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 0.5rem; border: 1px solid #d1d5db; display: none; }
        
        /* --- Notification & Celebration --- */
        #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notification { padding: 1rem 1.5rem; border-radius: 12px; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); font-weight: 600; animation: slide-in 0.5s forwards, slide-out 0.5s 3s forwards; }
        .notification.success { background: linear-gradient(135deg, var(--green), #34d399); }
        .notification.error { background: linear-gradient(135deg, var(--red), #f87171); }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-status { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); } }
        @keyframes slide-in { from { transform: translateX(calc(100% + 20px)); } to { transform: translateX(0); } }
        @keyframes slide-out { from { transform: translateX(0); } to { transform: translateX(calc(100% + 20px)); } }
        
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .section-header { flex-direction: column; align-items: stretch; text-align: center; }
            .items-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <section id="home" class="nav-section"></section>
        <section id="books" class="nav-section"></section>
        <section id="finished" class="nav-section"></section>
        <section id="clubs" class="nav-section"></section>
        <section id="bookReviews" class="nav-section"></section>
    </div>

    <div id="modal-container"></div>
    <div id="notification-container"></div>
    <div id="celebration-container"></div>
    
    <template id="modal-template-book">
        <div class="modal-backdrop">
            <div class="modal-content">
                <button class="modal-close-btn" data-action="close-modal">√ó</button>
                <h3>Libro Nuevo</h3>
                <form class="modal-form" data-section="books">
                    <input type="hidden" name="id">
                    <div class="form-group">
                        <label for="bookTitle">T√≠tulo</label>
                        <input type="text" id="bookTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Autor(a)</label>
                        <input type="text" id="bookAuthor" name="author" required>
                    </div>
                    <div class="form-group">
                        <label for="bookCoverImage">Portada (Opcional)</label>
                        <input type="file" id="bookCoverImage" name="coverImageFile" accept="image/*">
                        <img class="image-preview" alt="Vista previa">
                    </div>
                    <button type="submit" class="btn">Guardar Libro</button>
                </form>
            </div>
        </div>
    </template>
    
    <template id="modal-template-club">
         <div class="modal-backdrop">
            <div class="modal-content">
                <button class="modal-close-btn" data-action="close-modal">√ó</button>
                <h3>Club de Lectura</h3>
                <form class="modal-form" data-section="clubs">
                    <input type="hidden" name="id">
                    <div class="form-group">
                        <label for="clubName">Nombre del Club</label>
                        <input type="text" id="clubName" name="name" required>
                    </div>
                     <div class="form-group">
                        <label for="clubMembers">N¬∫ de Integrantes</label>
                        <input type="number" id="clubMembers" name="memberCount" min="1">
                    </div>
                    <button type="submit" class="btn">Guardar Club</button>
                </form>
            </div>
        </div>
    </template>


<script>
// ===================================================================================
// MERAKELYSI APP 5.0 - ARQUITECTURA FINAL Y CORREGIDA
// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {

    /**
     * -----------------------------------------------------------------------------
     * M√ìDULO DE CONFIGURACI√ìN Y ESTADO
     * -----------------------------------------------------------------------------
     */
    const config = {
        storageKey: 'merakelysi_data_v5',
        userNameKey: 'merakelysi_userName_v5',
        sections: [
            { id: 'books', title: 'Mis Libros por Leer', icon: 'üìö', modalId: 'bookModal', templateId: 'modal-template-book' },
            { id: 'finished', title: 'Lecturas Terminadas', icon: '‚úÖ' },
            { id: 'clubs', title: 'Mis Clubes de Lectura', icon: 'üë•', modalId: 'clubModal', templateId: 'modal-template-club' },
            { id: 'bookReviews', title: 'Mis Rese√±as', icon: 'üñãÔ∏è'},
            // A√±ade futuras secciones aqu√≠ siguiendo el mismo patr√≥n
        ],
    };

    const state = {
        currentSection: 'home',
        userName: '',
        db: {},
        tempCoverImage: null,
    };

    /**
     * -----------------------------------------------------------------------------
     * M√ìDULO DE UTILIDADES
     * -----------------------------------------------------------------------------
     */
    const utils = {
        generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9),
        sanitizeHTML: (str) => {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        },
    };

    /**
     * -----------------------------------------------------------------------------
     * M√ìDULO DE ALMACENAMIENTO (LocalStorage)
     * -----------------------------------------------------------------------------
     */
    const storage = {
        save() {
            try {
                localStorage.setItem(config.storageKey, JSON.stringify(state.db));
                console.log('‚úÖ Datos guardados');
            } catch (e) {
                console.error('‚ùå Error al guardar datos:', e);
                ui.showNotification('Error al guardar los datos.', 'error');
            }
        },
        load() {
            const emptyDB = { books: [], clubs: [], reviews: [] };
            try {
                const savedData = localStorage.getItem(config.storageKey);
                const parsedData = savedData ? JSON.parse(savedData) : {};
                state.db = { ...emptyDB, ...parsedData };
                
                // Asegura la integridad de los datos de libros
                if (state.db.books) {
                    state.db.books = state.db.books.map(book => ({
                        isFinished: false, coverImage: null, ...book
                    }));
                }
            } catch (e) {
                console.error('‚ùå Error al cargar datos:', e);
                state.db = emptyDB;
            }
        },
        getUserName: () => localStorage.getItem(config.userNameKey) || '',
        saveUserName: (name) => localStorage.setItem(config.userNameKey, name),
    };

    /**
     * -----------------------------------------------------------------------------
     * M√ìDULO DE MODALES
     * -----------------------------------------------------------------------------
     */
    const modals = {
        open(modalId, itemId = null) {
            const sectionConfig = config.sections.find(s => s.modalId === modalId);
            if (!sectionConfig) return;

            const template = document.getElementById(sectionConfig.templateId);
            if (!template) return;

            const clone = template.content.cloneNode(true);
            const modalEl = clone.querySelector('.modal-backdrop');
            const form = modalEl.querySelector('form');
            const titleEl = modalEl.querySelector('h3');

            state.tempCoverImage = null; // Reiniciar imagen temporal

            if (itemId) { // MODO EDICI√ìN
                const itemData = state.db[form.dataset.section]?.find(item => item.id == itemId);
                if (itemData) {
                    titleEl.textContent = titleEl.textContent.replace('Nuevo', 'Editar');
                    form.id.value = itemId; // Establecer el ID en el campo oculto
                    for (const key in itemData) {
                        if (form.elements[key]) form.elements[key].value = itemData[key];
                    }
                    if (itemData.coverImage) {
                        const preview = modalEl.querySelector('.image-preview');
                        preview.src = itemData.coverImage;
                        preview.style.display = 'block';
                    }
                }
            }
            ui.elements.modalContainer.innerHTML = '';
            ui.elements.modalContainer.appendChild(clone);
            requestAnimationFrame(() => modalEl.classList.add('active'));
            document.body.classList.add('modal-open');
        },
        close() {
            const modalEl = ui.elements.modalContainer.querySelector('.modal-backdrop');
            if (modalEl) {
                modalEl.classList.remove('active');
                modalEl.addEventListener('transitionend', () => {
                    ui.elements.modalContainer.innerHTML = '';
                    document.body.classList.remove('modal-open');
                }, { once: true });
            }
        }
    };
    
    /**
     * -----------------------------------------------------------------------------
     * M√ìDULO DE RENDERIZADO (UI)
     * -----------------------------------------------------------------------------
     */
    const rendering = {
        home() {
            const homeSection = document.getElementById('home');
            homeSection.innerHTML = `
                <header class="header">
                    <h1 class="title">Merakelysi</h1>
                    <p class="author-attribution">By Maribel Alba</p>
                    <div class="user-name-input">
                        <label>Hola, </label>
                        <input type="text" id="userName" placeholder="tu nombre" value="${utils.sanitizeHTML(state.userName)}">
                    </div>
                    <div class="status"><div class="status-dot"></div><span>Datos guardados en tu navegador</span></div>
                </header>
                <main class="grid">
                    ${config.sections.map(s => `
                        <div class="card" data-action="navigate" data-section-id="${s.id}">
                            <div class="card-icon">${s.icon}</div>
                            <h3 class="card-title">${s.title}${s.dev ? ' (Pr√≥ximamente)' : ''}</h3>
                        </div>`).join('')}
                </main>`;
        },
        
        page(sectionId, detailId = null) {
            const sectionConfig = config.sections.find(s => s.id === sectionId);
            if (!sectionConfig) return;

            const sectionEl = document.getElementById(sectionId);
            sectionEl.innerHTML = `
                <div class="section-header">
                    <button class="btn back-btn" data-action="navigate" data-section-id="home">‚Üê Inicio</button>
                    <h2 class="section-title">${sectionConfig.title}</h2>
                    ${sectionConfig.modalId ? `<button class="btn" data-action="open-modal" data-modal-id="${sectionConfig.modalId}">+ Nuevo</button>` : ''}
                </div>
                <div id="${sectionId}Container" class="${sectionId === 'bookReviews' ? '' : 'items-grid'}"></div>`;

            const container = document.getElementById(`${sectionId}Container`);
            const renderFn = this[sectionId] || this.default;
            renderFn(container, sectionConfig, detailId);
        },
        
        books(container) {
            const items = state.db.books.filter(b => !b.isFinished);
            if (!items.length) return this._renderEmptyState(container, 'üìö', 'No hay libros por leer', 'Agrega uno para empezar.');
            container.innerHTML = items.map(book => this._createBookCard(book)).join('');
        },
        
        finished(container) {
            const items = state.db.books.filter(b => b.isFinished);
            if (!items.length) return this._renderEmptyState(container, '‚úÖ', 'A√∫n no has terminado ning√∫n libro', '¬°Sigue leyendo!');
            container.innerHTML = items.map(book => this._createBookCard(book)).join('');
        },

        clubs(container) {
             const items = state.db.clubs;
             if (!items.length) return this._renderEmptyState(container, 'üë•', 'A√∫n no tienes clubes de lectura', '¬°Crea uno y comparte la magia!');
             container.innerHTML = items.map(club => `
                <div class="item-card" data-id="${club.id}">
                    <div class="item-content">
                         <button class="delete-btn" data-action="delete-item" data-section="clubs" data-id="${club.id}">√ó</button>
                         <h3 class="item-title">${utils.sanitizeHTML(club.name)}</h3>
                         <p class="item-subtitle">${club.memberCount || 0} integrantes</p>
                         <div class="item-actions">
                            <button class="action-btn action-edit" data-action="edit-item" data-section="clubs" data-id="${club.id}">Editar</button>
                         </div>
                    </div>
                </div>`).join('');
        },

        bookReviews(container, _, bookId) {
             if (!bookId) {
                 this._renderEmptyState(container, 'üñãÔ∏è', 'Selecciona un libro terminado', 'Elige un libro de tu lista de "Lecturas Terminadas" para ver su rese√±a.');
                 return;
             }
             const book = state.db.books.find(b => b.id == bookId);
             const review = state.db.reviews.find(r => r.bookId == bookId);
             if (!book) { this._renderEmptyState(container, '‚ùì', 'Libro no encontrado', ''); return; }

             container.innerHTML = this._createBookReviewDisplay(book, review);
        },

        _createBookCard(book) {
            const hasReview = book.isFinished && state.db.reviews.find(r => r.bookId == book.id);
            let actionButton;
            if (book.isFinished) {
                actionButton = `<button class="action-btn action-review" data-action="write-review" data-id="${book.id}">${hasReview ? 'Ver Rese√±a' : '‚úçÔ∏è Rese√±ar'}</button>`;
            } else {
                actionButton = `<button class="action-btn action-finish" data-action="finish-book" data-id="${book.id}">‚úÖ Terminar</button>`;
            }

            return `
            <div class="item-card ${book.coverImage ? 'has-image' : ''}" data-id="${book.id}">
                ${book.coverImage ? `<img src="${book.coverImage}" alt="Portada" class="item-card-image">` : ''}
                <div class="item-content">
                    <button class="delete-btn" data-action="delete-item" data-section="books" data-id="${book.id}">√ó</button>
                    <h3 class="item-title">${utils.sanitizeHTML(book.title)}</h3>
                    <p class="item-subtitle">${utils.sanitizeHTML(book.author)}</p>
                    <div class="item-actions">
                        <button class="action-btn action-edit" data-action="edit-item" data-section="books" data-id="${book.id}">Editar</button>
                        ${actionButton}
                    </div>
                </div>
            </div>`;
        },
        
        _createBookReviewDisplay(book, review) {
            if (!review) {
                 return `<div class="empty-state">
                    <div class="card-icon">ü§î</div>
                    <h3>Este libro a√∫n no tiene rese√±a.</h3>
                    <button class="btn" data-action="open-modal" data-modal-id="reviewModal" data-book-id="${book.id}">+ Escribir Rese√±a</button>
                 </div>`;
            }
            
            const ratingHtml = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
            return `<div class="book-review-display">
                <div class="review-header"><h2>Rese√±a de: ${utils.sanitizeHTML(book.title)}</h2></div>
                <div class="review-grid">
                    <div class="review-main-content">
                        <div class="review-section"><h3>Lo que m√°s me gust√≥:</h3><p>${utils.sanitizeHTML(review.likedMost)}</p></div>
                        <div class="review-section"><h3>Personajes Favoritos:</h3><p>${utils.sanitizeHTML(review.favoriteCharacters)}</p></div>
                    </div>
                    <div class="review-sidebar">
                        <img src="${book.coverImage || 'https://via.placeholder.com/200x300.png?text=Sin+Portada'}" alt="Portada" class="review-cover">
                        <div class="review-section"><h3>Calificaci√≥n</h3><div class="rating-display">${ratingHtml.replace(/‚òÖ/g, '<span class="filled">‚òÖ</span>').replace(/‚òÜ/g, '<span class="empty">‚òÜ</span>')}</div></div>
                    </div>
                </div>
            </div>`;
        },

        _renderEmptyState(container, icon, message, submessage) {
            container.className = '';
            container.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><div class="card-icon">${icon}</div><h3>${message}</h3><p>${submessage}</p></div>`;
        },
    };

    /**
     * -----------------------------------------------------------------------------
     * M√ìDULO PRINCIPAL DE LA APP
     * -----------------------------------------------------------------------------
     */
    const app = {
        init() {
            storage.load();
            storage.loadUserName();
            this.addEventListeners();
            ui.renderSection('home');
            console.log("ü¶Ñ Merakelysi App 5.0 inicializada.");
        },

        addEventListeners() {
            // Delegaci√≥n de eventos principal
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const { action, id, sectionId, modalId, bookId } = target.dataset;
                const handler = this.actions[action];
                if (handler) handler.call(this, id, { sectionId, modalId, bookId });
            });
            
            // Listener para el nombre de usuario
            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'userName') storage.saveUserName(e.target.value);
                if (e.target.type === 'file' && e.target.name === 'coverImageFile') this.handleImagePreview(e.target);
            });
            
            // Listener para los formularios en los modales
            ui.elements.modalContainer.addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.tagName === 'FORM') this.handleFormSubmit(e.target);
            });

            window.addEventListener('beforeunload', storage.save);
        },

        actions: {
            navigate(id, { sectionId }) { ui.renderSection(sectionId, id); },
            'open-modal'(id, { modalId }) { modals.open(modalId, id); },
            'close-modal'() { modals.close(); },
            'edit-item'(id, { sectionId }) {
                const modalId = config.sections.find(s => s.id === sectionId)?.modalId;
                if (modalId) modals.open(modalId, id);
            },
            'delete-item'(id, { sectionId }) {
                if (confirm('¬øEst√°s segura de que quieres eliminar este elemento?')) {
                    state.db[sectionId] = state.db[sectionId].filter(item => item.id != id);
                    if(sectionId === 'books') { // Borrar tambi√©n la rese√±a asociada
                        state.db.reviews = state.db.reviews.filter(r => r.bookId != id);
                    }
                    ui.renderPage(sectionId);
                    ui.showNotification('Elemento eliminado.', 'success');
                }
            },
            'finish-book'(id) {
                const book = state.db.books.find(b => b.id == id);
                if (book && confirm(`¬øMarcar "${book.title}" como terminado?`)) {
                    book.isFinished = true;
                    ui.renderPage('books');
                    ui.showCelebration(`¬°Felicidades por terminar "${book.title}"!`);
                }
            },
            'write-review'(bookId) {
                const review = state.db.reviews.find(r => r.bookId == bookId);
                if (review) {
                    ui.renderSection('bookReviews', bookId);
                } else {
                    modals.open('reviewModal', bookId);
                }
            }
        },
        
        handleImagePreview(fileInput) {
            const file = fileInput.files[0];
            const previewEl = fileInput.closest('.form-group').querySelector('.image-preview');
            if (!file) {
                state.tempCoverImage = null;
                previewEl.style.display = 'none';
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                state.tempCoverImage = e.target.result;
                previewEl.src = e.target.result;
                previewEl.style.display = 'block';
            };
            reader.readAsDataURL(file);
        },

        handleFormSubmit(form) {
            const sectionKey = form.dataset.section;
            if (!state.db[sectionKey]) return;

            const formData = new FormData(form);
            const itemData = Object.fromEntries(formData.entries());
            const itemId = form.id.value;

            // Limpieza de datos
            delete itemData.coverImageFile; // Eliminar el campo del archivo

            if (state.tempCoverImage) {
                itemData.coverImage = state.tempCoverImage;
            }

            if (itemId) { // Editar
                const index = state.db[sectionKey].findIndex(item => item.id == itemId);
                if (index > -1) {
                    if (!itemData.coverImage) itemData.coverImage = state.db[sectionKey][index].coverImage; // Mantener imagen anterior si no se sube una nueva
                    state.db[sectionKey][index] = { ...state.db[sectionKey][index], ...itemData };
                    ui.showNotification('¬°Actualizado con √©xito!');
                }
            } else { // Agregar
                itemData.id = utils.generateId();
                if (sectionKey === 'books') itemData.isFinished = false;
                state.db[sectionKey].push(itemData);
                ui.showNotification('¬°Elemento agregado!');
            }
            
            modals.close();
            ui.renderPage(sectionKey);
            storage.save();
        },
    };

    app.init();
});
</script>

</body>
</html>
